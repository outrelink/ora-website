<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ORA Admin Dashboard</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Manrope:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- Preload Protos font for faster loading -->
    <link rel="preload" href="Protos.otf" as="font" type="font/otf" crossorigin>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #ffffff;
            color: #1e293b;
            min-height: 100vh;
            margin: 0;
            padding: 0;
        }

        .container {
            max-width: 100%;
            margin: 0;
            position: relative;
            z-index: 1;
        }

        /* Auth Section */
        .auth-section {
            max-width: 420px;
            margin: 120px auto;
            padding: 48px;
            border-radius: 24px;
            border: 1px solid #e2e8f0;
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(40px);
            -webkit-backdrop-filter: blur(40px);
            text-align: center;
            box-shadow: 0 2px 0 rgba(0,0,0,0.03), 0 24px 48px -24px rgba(0,0,0,0.25);
        }

        .auth-section h2 {
            font-family: 'Manrope', sans-serif;
            font-size: 28px;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 8px;
        }

        .auth-section p {
            font-size: 14px;
            color: #64748b;
            margin-bottom: 32px;
        }

        .auth-section input {
            width: 100%;
            padding: 14px 16px;
            margin-bottom: 16px;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            background: #ffffff;
            color: #1e293b;
            font-size: 15px;
            font-family: 'Inter', sans-serif;
            transition: all 0.3s;
        }

        .auth-section input:focus {
            outline: none;
            border-color: #f97316;
            box-shadow: 0 0 0 3px rgba(249, 115, 22, 0.1);
        }

        .auth-section input::placeholder {
            color: #94a3b8;
        }

        .auth-section button {
            width: 100%;
            padding: 14px;
            margin-top: 8px;
            background: #f97316;
            border: 1px solid #f97316;
            border-radius: 12px;
            color: #ffffff;
            font-weight: 600;
            font-size: 15px;
            font-family: 'Inter', sans-serif;
            cursor: pointer;
            transition: all 0.3s;
        }

        .auth-section button:hover {
            background: #ea580c;
            border-color: #ea580c;
        }

        .auth-error {
            color: #ff3b30;
            font-size: 14px;
            margin-top: 12px;
            display: none;
        }

        /* Dashboard Layout */
        #dashboard {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: 280px;
            background: rgba(255, 255, 255, 0.9);
            border-right: 1px solid #e2e8f0;
            padding: 0;
            position: fixed;
            left: 0;
            top: 0;
            height: 100vh;
            overflow-y: auto;
            z-index: 100;
            backdrop-filter: blur(40px);
            -webkit-backdrop-filter: blur(40px);
        }

        .sidebar::-webkit-scrollbar {
            width: 6px;
        }

        .sidebar::-webkit-scrollbar-track {
            background: transparent;
        }

        .sidebar::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 3px;
        }

        .sidebar::-webkit-scrollbar-thumb:hover {
            background: rgba(0, 0, 0, 0.3);
        }

        .sidebar-header {
            padding: 24px 20px;
            border-bottom: 1px solid #e2e8f0;
        }

        .sidebar-header h1 {
            font-family: 'Manrope', sans-serif;
            font-size: 24px;
            font-weight: 600;
            color: #1e293b;
            letter-spacing: -0.5px;
            margin: 0 0 8px 0;
        }

        .sidebar-header .logout-btn {
            padding: 8px 16px;
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.2);
            border-radius: 8px;
            color: #ef4444;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            font-family: 'Inter', sans-serif;
            width: 100%;
        }

        .sidebar-header .logout-btn:hover {
            background: rgba(239, 68, 68, 0.15);
            border-color: rgba(239, 68, 68, 0.3);
        }

        .sidebar-nav {
            padding: 16px 0;
        }

        .nav-section {
            margin-bottom: 32px;
        }

        .nav-section-title {
            padding: 8px 20px;
            font-size: 11px;
            font-weight: 600;
            color: #475569;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-family: 'Inter', sans-serif;
        }

        .nav-item {
            display: flex;
            align-items: center;
            padding: 12px 20px;
            color: #334155;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            font-family: 'Inter', sans-serif;
            border-left: 3px solid transparent;
        }

        .nav-item:hover {
            background: rgba(0, 0, 0, 0.03);
            color: #1e293b;
        }

        .nav-item.active {
            background: rgba(249, 115, 22, 0.1);
            border-left-color: #f97316;
            color: #1e293b;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            margin-left: 280px;
            padding: 32px;
            min-height: 100vh;
        }

        .content-header {
            margin-bottom: 32px;
        }

        .content-header h2 {
            font-family: 'Manrope', sans-serif;
            font-size: 32px;
            font-weight: 600;
            color: #1e293b;
            letter-spacing: -0.5px;
            margin: 0 0 8px 0;
        }

        .content-header p {
            color: #64748b;
            font-size: 14px;
            margin: 0;
        }

        /* Content */
        .content {
            display: none;
        }

        .content.active {
            display: block;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
            gap: 20px;
            margin-bottom: 32px;
        }

        .stat-card {
            padding: 24px;
            border-radius: 16px;
            border: 1px solid #e2e8f0;
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(40px);
            -webkit-backdrop-filter: blur(40px);
            transition: all 0.3s;
        }

        .stat-card:hover {
            background: rgba(255, 255, 255, 0.95);
            border-color: #cbd5e1;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .stat-card h3 {
            font-size: 13px;
            font-weight: 500;
            color: #64748b;
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-family: 'Inter', sans-serif;
        }

        .stat-card .value {
            font-family: 'Manrope', sans-serif;
            font-size: 36px;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 8px;
            line-height: 1.2;
        }

        .stat-card .label {
            font-size: 13px;
            color: #64748b;
            font-family: 'Inter', sans-serif;
        }

        /* Table Container */
        .table-container {
            padding: 28px;
            border-radius: 16px;
            border: 1px solid #e2e8f0;
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(40px);
            -webkit-backdrop-filter: blur(40px);
            overflow-x: auto;
            margin-bottom: 24px;
        }

        .table-container h3 {
            font-family: 'Manrope', sans-serif;
            font-size: 20px;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 24px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 14px 16px;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }

        th {
            font-weight: 600;
            color: #64748b;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-family: 'Inter', sans-serif;
        }

        td {
            color: #1e293b;
            font-size: 14px;
            font-family: 'Inter', sans-serif;
        }

        tr:hover {
            background: rgba(0, 0, 0, 0.02);
        }

        /* Filter Bar */
        .filter-bar {
            display: flex;
            gap: 12px;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 10px 20px;
            border-radius: 12px;
            border: 1px solid #e2e8f0;
            background: rgba(255, 255, 255, 0.8);
            color: #334155;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            font-family: 'Inter', sans-serif;
        }

        .filter-btn:hover {
            background: rgba(255, 255, 255, 0.95);
            color: #1e293b;
        }

        .filter-btn.active {
            background: rgba(249, 115, 22, 0.15);
            border-color: #f97316;
            color: #1e293b;
        }

        /* Badges */
        .badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
            font-family: 'Inter', sans-serif;
        }

        .badge.rate {
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
        }

        .badge.bug {
            background: rgba(255, 59, 48, 0.2);
            color: #ff3b30;
        }

        /* Loading & Error States */
        .loading, .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #64748b;
            font-family: 'Inter', sans-serif;
        }

        .error {
            padding: 16px;
            border-radius: 12px;
            background: rgba(255, 59, 48, 0.1);
            border: 1px solid rgba(255, 59, 48, 0.2);
            color: #ff3b30;
            margin-bottom: 20px;
            font-family: 'Inter', sans-serif;
        }

        /* Email Modal */
        .email-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(4px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .email-modal.active {
            display: flex;
        }

        .email-modal-content {
            background: rgba(255, 255, 255, 0.95);
            border: 1px solid #e2e8f0;
            border-radius: 20px;
            padding: 32px;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            backdrop-filter: blur(40px);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .email-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .email-modal-header h2 {
            font-family: 'Manrope', sans-serif;
            font-size: 24px;
            font-weight: 600;
            color: #1e293b;
            margin: 0;
        }

        .email-modal-close {
            background: rgba(0, 0, 0, 0.05);
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: #1e293b;
            font-size: 20px;
            transition: all 0.3s;
        }

        .email-modal-close:hover {
            background: rgba(0, 0, 0, 0.1);
        }

        .email-form-group {
            margin-bottom: 20px;
        }

        .email-form-group label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            color: #1e293b;
            margin-bottom: 8px;
            font-family: 'Inter', sans-serif;
        }

        .email-form-group input,
        .email-form-group textarea {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid #e2e8f0;
            border-radius: 10px;
            background: #ffffff;
            color: #1e293b;
            font-size: 14px;
            font-family: 'Inter', sans-serif;
            transition: all 0.3s;
        }

        .email-form-group input:focus,
        .email-form-group textarea:focus {
            outline: none;
            border-color: #f97316;
            box-shadow: 0 0 0 3px rgba(249, 115, 22, 0.1);
        }

        .email-form-group textarea {
            min-height: 150px;
            resize: vertical;
        }

        .email-form-group input::placeholder,
        .email-form-group textarea::placeholder {
            color: #94a3b8;
        }

        .email-modal-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 24px;
        }

        .email-modal-btn {
            padding: 12px 24px;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            font-family: 'Inter', sans-serif;
            transition: all 0.3s;
            border: none;
        }

        .email-modal-btn-primary {
            background: #f97316;
            border: 1px solid #f97316;
            color: #ffffff;
        }

        .email-modal-btn-primary:hover {
            background: #ea580c;
            border-color: #ea580c;
        }

        .email-modal-btn-secondary {
            background: rgba(255, 255, 255, 0.8);
            border: 1px solid #e2e8f0;
            color: #1e293b;
        }

        .email-modal-btn-secondary:hover {
            background: rgba(255, 255, 255, 0.95);
        }

        .email-success {
            padding: 12px 16px;
            border-radius: 10px;
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.2);
            color: #10b981;
            margin-bottom: 16px;
            font-size: 14px;
            font-family: 'Inter', sans-serif;
            display: none;
        }

        .email-success.show {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Auth Section (shown when not authenticated) -->
        <div id="authSection" class="auth-section">
            <h2>Admin Login</h2>
            <p>Enter your password to access the dashboard</p>
            <input type="password" id="adminPassword" placeholder="Enter admin password" />
            <button onclick="authenticate()">Login</button>
            <p id="authError" class="auth-error"></p>
        </div>

        <!-- Main Dashboard (shown when authenticated) -->
        <div id="dashboard" style="display: none;">
            <!-- Sidebar Navigation -->
            <div class="sidebar">
                <div class="sidebar-header">
                    <h1>ORA Admin</h1>
                    <button class="logout-btn" onclick="logout()">Logout</button>
                </div>
                <nav class="sidebar-nav">
                    <div class="nav-section">
                        <div class="nav-section-title">Dashboard</div>
                        <div class="nav-item active" onclick="switchTab('overview')">Overview</div>
                    </div>
                    <div class="nav-section">
                        <div class="nav-section-title">Users & Revenue</div>
                        <div class="nav-item" onclick="switchTab('users')">Users</div>
                        <div class="nav-item" onclick="switchTab('subscriptions')">Subscriptions</div>
                        <div class="nav-item" onclick="switchTab('deals')">Deals & Revenue</div>
                        <div class="nav-item" onclick="switchTab('quotes')">Quotes</div>
                    </div>
                    <div class="nav-section">
                        <div class="nav-section-title">Analytics & Insights</div>
                        <div class="nav-item" onclick="switchTab('business')">Business Intelligence</div>
                        <div class="nav-item" onclick="switchTab('analytics')">Analytics</div>
                    </div>
                    <div class="nav-section">
                        <div class="nav-section-title">Email Management</div>
                        <div class="nav-item" onclick="switchTab('email-history')">Email History</div>
                        <div class="nav-item" onclick="switchTab('send-email')">Send Email</div>
                        <div class="nav-item" onclick="switchTab('welcome-emails')">Welcome Emails</div>
                        <div class="nav-item" onclick="switchTab('bulk-email')">Bulk Email</div>
                        <div class="nav-item" onclick="switchTab('creator-pool')">Creator Pool</div>
                        <div class="nav-item" onclick="switchTab('marketing')">Marketing</div>
                    </div>
                    <div class="nav-section">
                        <div class="nav-section-title">User Engagement</div>
                        <div class="nav-item" onclick="switchTab('submissions')">Submissions</div>
                        <div class="nav-item" onclick="switchTab('waitlist')">Waitlist</div>
                    </div>
                    <div class="nav-section">
                        <div class="nav-section-title">System</div>
                        <div class="nav-item" onclick="switchTab('errors')">Errors</div>
                    </div>
                </nav>
            </div>

            <!-- Main Content Area -->
            <div class="main-content">

            <!-- Overview Tab -->
            <div id="overview" class="content active">
                <div class="content-header">
                    <h2>Dashboard Overview</h2>
                    <p>Key metrics and recent activity at a glance</p>
                </div>

                <div class="stats-grid" style="margin-bottom: 30px;">
                    <div class="stat-card" style="background: linear-gradient(135deg, rgba(249, 115, 22, 0.1) 0%, rgba(249, 115, 22, 0.05) 100%); border: 1px solid rgba(249, 115, 22, 0.2);">
                        <h3>Total Revenue</h3>
                        <div class="value" id="overviewTotalRevenue" style="color: #1e293b;">-</div>
                        <div class="label">All revenue sources</div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, rgba(59, 130, 246, 0.15) 0%, rgba(59, 130, 246, 0.05) 100%); border: 1px solid rgba(59, 130, 246, 0.2);">
                        <h3>Total Users</h3>
                        <div class="value" id="overviewTotalUsers" style="color: #3b82f6;">-</div>
                        <div class="label">Registered users</div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, rgba(16, 185, 129, 0.15) 0%, rgba(16, 185, 129, 0.05) 100%); border: 1px solid rgba(16, 185, 129, 0.2);">
                        <h3>Active Subscriptions</h3>
                        <div class="value" id="overviewActiveSubs" style="color: #10b981;">-</div>
                        <div class="label">Paid subscribers</div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, rgba(245, 158, 11, 0.15) 0%, rgba(245, 158, 11, 0.05) 100%); border: 1px solid rgba(245, 158, 11, 0.2);">
                        <h3>Monthly Recurring Revenue</h3>
                        <div class="value" id="overviewMRR" style="color: #f59e0b;">-</div>
                        <div class="label">MRR</div>
                    </div>
                    <div class="stat-card">
                        <h3>Rate Submissions</h3>
                        <div class="value" id="rateSubmissionsCount">-</div>
                        <div class="label">Total submissions</div>
                    </div>
                    <div class="stat-card">
                        <h3>Bug Reports</h3>
                        <div class="value" id="bugReportsCount">-</div>
                        <div class="label">Total reports</div>
                    </div>
                    <div class="stat-card">
                        <h3>User Feedback</h3>
                        <div class="value" id="userFeedbackCount">-</div>
                        <div class="label">Feedback received</div>
                    </div>
                    <div class="stat-card">
                        <h3>Active Users (30d)</h3>
                        <div class="value" id="activeUsersCount">-</div>
                        <div class="label">Monthly active</div>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 30px;">
                    <div class="table-container">
                        <h3>Recent Submissions</h3>
                        <div id="recentActivity" style="max-height: 400px; overflow-y: auto;">
                            <div class="loading">Loading...</div>
                        </div>
                    </div>
                    <div class="table-container">
                        <h3>Quick Actions</h3>
                        <div style="padding: 20px;">
                            <button 
                                onclick="switchTab('subscriptions')" 
                                style="width: 100%; padding: 14px; margin-bottom: 12px; background: rgba(255, 255, 255, 0.8); border: 1px solid #e2e8f0; border-radius: 10px; color: #1e293b; font-size: 14px; font-weight: 500; cursor: pointer; font-family: 'Inter', sans-serif; transition: all 0.3s; text-align: left;"
                                onmouseover="this.style.background='rgba(255, 255, 255, 0.95)'"
                                onmouseout="this.style.background='rgba(255, 255, 255, 0.8)'"
                            >
                                View Subscriptions & Revenue
                            </button>
                            <button 
                                onclick="switchTab('submissions')" 
                                style="width: 100%; padding: 14px; margin-bottom: 12px; background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.3); border-radius: 10px; color: #1e293b; font-size: 14px; font-weight: 500; cursor: pointer; font-family: 'Inter', sans-serif; transition: all 0.3s; text-align: left;"
                                onmouseover="this.style.background='#2563eb'"
                                onmouseout="this.style.background='#3b82f6'"
                            >
                                Review Feedback & Reports
                            </button>
                            <button 
                                onclick="switchTab('users')" 
                                style="width: 100%; padding: 14px; margin-bottom: 12px; background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.3); border-radius: 10px; color: #1e293b; font-size: 14px; font-weight: 500; cursor: pointer; font-family: 'Inter', sans-serif; transition: all 0.3s; text-align: left;"
                                onmouseover="this.style.background='rgba(16, 185, 129, 0.2)'"
                                onmouseout="this.style.background='rgba(16, 185, 129, 0.1)'"
                            >
                                Manage Users
                            </button>
                            <button 
                                onclick="switchTab('business')" 
                                style="width: 100%; padding: 14px; background: rgba(139, 92, 246, 0.1); border: 1px solid rgba(139, 92, 246, 0.3); border-radius: 10px; color: #1e293b; font-size: 14px; font-weight: 500; cursor: pointer; font-family: 'Inter', sans-serif; transition: all 0.3s; text-align: left;"
                                onmouseover="this.style.background='rgba(139, 92, 246, 0.2)'"
                                onmouseout="this.style.background='rgba(139, 92, 246, 0.1)'"
                            >
                                Business Intelligence
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Users Tab -->
            <div id="users" class="content">
                <div class="content-header">
                    <h2>Users</h2>
                    <p>Manage and monitor all registered users</p>
                </div>
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3>Total Users</h3>
                        <div class="value" id="usersTotalCount">-</div>
                        <div class="label">All registered users</div>
                    </div>
                    <div class="stat-card">
                        <h3>Active Users</h3>
                        <div class="value" id="usersActiveCount">-</div>
                        <div class="label">Active in last 7 days</div>
                    </div>
                    <div class="stat-card">
                        <h3>Subscribed Users</h3>
                        <div class="value" id="usersSubscribedCount">-</div>
                        <div class="label">Paid subscriptions</div>
                    </div>
                    <div class="stat-card">
                        <h3>Free Users</h3>
                        <div class="value" id="usersFreeCount">-</div>
                        <div class="label">Not subscribed</div>
                    </div>
                </div>
                <div class="table-container">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 style="margin: 0;">All Users</h3>
                        <div style="display: flex; gap: 12px; align-items: center;">
                            <input 
                                type="text" 
                                id="usersSearch" 
                                placeholder="Search users..." 
                                style="padding: 10px 16px; border: 1px solid #e2e8f0; border-radius: 10px; background: #ffffff; color: #1e293b; font-size: 14px; width: 250px; font-family: 'Inter', sans-serif;"
                                onkeyup="filterUsers()"
                            />
                            <button 
                                onclick="openEmailModal()" 
                                style="padding: 10px 20px; background: #3b82f6; border: 1px solid #3b82f6; border-radius: 10px; color: #ffffff; font-size: 14px; font-weight: 500; cursor: pointer; font-family: 'Inter', sans-serif; transition: all 0.3s;"
                                onmouseover="this.style.background='#2563eb'"
                                onmouseout="this.style.background='#3b82f6'"
                            >
                                Send Email
                            </button>
                            <button 
                                onclick="exportUsersCSV()" 
                                style="padding: 10px 20px; background: rgba(255, 255, 255, 0.8); border: 1px solid #e2e8f0; border-radius: 10px; color: #1e293b; font-size: 14px; font-weight: 500; cursor: pointer; font-family: 'Inter', sans-serif; transition: all 0.3s;"
                                onmouseover="this.style.background='rgba(255, 255, 255, 0.95)'"
                                onmouseout="this.style.background='rgba(255, 255, 255, 0.8)'"
                            >
                                Export CSV
                            </button>
                        </div>
                    </div>
                    <div id="usersList">
                        <div class="loading">Loading...</div>
                    </div>
                    </div>
                </div>

            <!-- Deals & Revenue Tab -->
            <div id="deals" class="content">
                <div class="content-header">
                    <h2>Deals & Revenue Tracking</h2>
                    <p>Deals that users are tracking in the app, including active projects and completed work</p>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <h3>Total Deals</h3>
                        <div class="value" id="dealsTotalCount">-</div>
                        <div class="label">All deals tracked by users</div>
                    </div>
                    <div class="stat-card">
                        <h3>Total Revenue</h3>
                        <div class="value" id="dealsTotalRevenue">-</div>
                        <div class="label">Combined value of all deals</div>
                    </div>
                    <div class="stat-card">
                        <h3>Active Deals</h3>
                        <div class="value" id="dealsActiveCount">-</div>
                        <div class="label">Currently in progress</div>
                    </div>
                    <div class="stat-card">
                        <h3>Completed Deals</h3>
                        <div class="value" id="dealsCompletedCount">-</div>
                        <div class="label">Successfully completed projects</div>
                    </div>
                </div>
                <div class="table-container">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 style="margin: 0;">Recent Deals</h3>
                        <button 
                            onclick="exportDealsCSV()" 
                            style="padding: 10px 20px; background: rgba(255, 255, 255, 0.8); border: 1px solid #e2e8f0; border-radius: 10px; color: #1e293b; font-size: 14px; font-weight: 500; cursor: pointer; font-family: 'Inter', sans-serif; transition: all 0.3s;"
                            onmouseover="this.style.background='rgba(255, 255, 255, 0.25)'"
                            onmouseout="this.style.background='rgba(255, 255, 255, 0.15)'"
                        >
                            Export CSV
                        </button>
                    </div>
                    <div id="dealsList">
                        <div class="loading">Loading...</div>
                    </div>
                </div>
            </div>

            <!-- Subscriptions & Payments Tab -->
            <div id="subscriptions" class="content">
                <div class="content-header">
                    <h2>Subscriptions & Payments</h2>
                    <p>Monitor subscription plans, revenue, and payment metrics</p>
                </div>
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3>Monthly Recurring Revenue</h3>
                        <div class="value" id="subscriptionsMRR">-</div>
                        <div class="label">MRR</div>
                    </div>
                    <div class="stat-card">
                        <h3>Annual Recurring Revenue</h3>
                        <div class="value" id="subscriptionsARR">-</div>
                        <div class="label">ARR</div>
                    </div>
                    <div class="stat-card">
                        <h3>Active Subscriptions</h3>
                        <div class="value" id="subscriptionsActive">-</div>
                        <div class="label">Currently active</div>
                    </div>
                    <div class="stat-card">
                        <h3>Conversion Rate</h3>
                        <div class="value" id="subscriptionsConversion">-</div>
                        <div class="label">Free to paid</div>
                    </div>
                    <div class="stat-card">
                        <h3>Churn Rate</h3>
                        <div class="value" id="subscriptionsChurn">-</div>
                        <div class="label">Monthly churn</div>
                    </div>
                    <div class="stat-card">
                        <h3>Average Revenue Per User</h3>
                        <div class="value" id="subscriptionsARPU">-</div>
                        <div class="label">ARPU</div>
                    </div>
                </div>
                <div class="table-container">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 style="margin: 0;">Subscription Plans Breakdown</h3>
                        <button 
                            onclick="exportSubscriptionsCSV()" 
                            style="padding: 10px 20px; background: rgba(255, 255, 255, 0.8); border: 1px solid #e2e8f0; border-radius: 10px; color: #1e293b; font-size: 14px; font-weight: 500; cursor: pointer; font-family: 'Inter', sans-serif; transition: all 0.3s;"
                            onmouseover="this.style.background='rgba(255, 255, 255, 0.25)'"
                            onmouseout="this.style.background='rgba(255, 255, 255, 0.15)'"
                        >
                            Export CSV
                        </button>
                    </div>
                    <div id="subscriptionsList">
                        <div class="loading">Loading...</div>
                    </div>
                </div>
                <div class="table-container" style="margin-top: 30px;">
                    <h3>Monthly Revenue Trend</h3>
                    <div id="revenueChart" style="min-height: 300px; padding: 20px;">
                        <div class="loading">Loading chart...</div>
                    </div>
                </div>
            </div>

            <!-- Business Intelligence Tab -->
            <div id="business" class="content">
                <div class="content-header">
                    <h2>Business Intelligence Dashboard</h2>
                    <p>Comprehensive metrics for due diligence, valuation, and business insights</p>
                </div>

                <!-- Key Metrics Grid -->
                <div class="stats-grid" style="margin-bottom: 30px;">
                    <div class="stat-card">
                        <h3>Total Revenue</h3>
                        <div class="value" id="biTotalRevenue">-</div>
                        <div class="label">All revenue sources</div>
                    </div>
                    <div class="stat-card">
                        <h3>Total Users</h3>
                        <div class="value" id="biTotalUsers">-</div>
                        <div class="label">All registered users</div>
                    </div>
                    <div class="stat-card">
                        <h3>Active Users (30d)</h3>
                        <div class="value" id="biActiveUsers">-</div>
                        <div class="label">Monthly active</div>
                    </div>
                    <div class="stat-card">
                        <h3>ARR</h3>
                        <div class="value" id="biARR">-</div>
                        <div class="label">Annual recurring</div>
                    </div>
                    <div class="stat-card">
                        <h3>Lifetime Value</h3>
                        <div class="value" id="biLTV">-</div>
                        <div class="label">Customer LTV</div>
                    </div>
                    <div class="stat-card">
                        <h3>Retention Rate</h3>
                        <div class="value" id="biRetention">-</div>
                        <div class="label">User retention</div>
                    </div>
                </div>

                <!-- Revenue Breakdown -->
                <div class="table-container" style="margin-bottom: 30px;">
                    <h3>Revenue Breakdown</h3>
                    <div id="revenueBreakdown" style="padding: 20px;">
                        <div class="loading">Loading...</div>
                    </div>
                </div>

                <!-- Product Metrics -->
                <div class="table-container" style="margin-bottom: 30px;">
                    <h3>Product Usage Metrics</h3>
                    <div id="productMetrics" style="padding: 20px;">
                        <div class="loading">Loading...</div>
                    </div>
                </div>

                <!-- Growth Trends -->
                <div class="table-container" style="margin-bottom: 30px;">
                    <h3>User Growth Trend (Last 12 Months)</h3>
                    <div id="growthChart" style="min-height: 300px; padding: 20px;">
                        <div class="loading">Loading chart...</div>
                    </div>
                </div>

                <!-- Compliance & Legal -->
                <div class="table-container">
                    <h3>Compliance & Legal Status</h3>
                    <div id="complianceStatus" style="padding: 20px;">
                        <div class="loading">Loading...</div>
                    </div>
                </div>
            </div>

            <!-- Quotes Tab -->
            <div id="quotes" class="content">
                <div class="content-header">
                    <h2>Quotes Generated</h2>
                    <p>Professional quotes created by users for their projects</p>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <h3>Total Quotes</h3>
                        <div class="value" id="quotesTotalCount">-</div>
                        <div class="label">All quotes generated by users</div>
                    </div>
                    <div class="stat-card">
                        <h3>Accepted Quotes</h3>
                        <div class="value" id="quotesAcceptedCount">-</div>
                        <div class="label">Quotes that were accepted by clients</div>
                    </div>
                    <div class="stat-card">
                        <h3>Total Quote Value</h3>
                        <div class="value" id="quotesTotalValue">-</div>
                        <div class="label">Combined value of all quotes</div>
                    </div>
                    <div class="stat-card">
                        <h3>Accepted Value</h3>
                        <div class="value" id="quotesAcceptedValue">-</div>
                        <div class="label">Value from accepted quotes only</div>
                    </div>
                </div>
                <div class="table-container">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 style="margin: 0;">Recent Quotes</h3>
                        <button 
                            onclick="exportQuotesCSV()" 
                            style="padding: 10px 20px; background: rgba(255, 255, 255, 0.8); border: 1px solid #e2e8f0; border-radius: 10px; color: #1e293b; font-size: 14px; font-weight: 500; cursor: pointer; font-family: 'Inter', sans-serif; transition: all 0.3s;"
                            onmouseover="this.style.background='rgba(255, 255, 255, 0.25)'"
                            onmouseout="this.style.background='rgba(255, 255, 255, 0.15)'"
                        >
                            Export CSV
                        </button>
                    </div>
                    <div id="quotesList">
                        <div class="loading">Loading...</div>
                    </div>
                </div>
            </div>

            <!-- Submissions Tab -->
            <div id="submissions" class="content">
                <div class="content-header">
                    <h2>User Submissions & Feedback</h2>
                    <p>Review and respond to user feedback, bug reports, and rate submissions</p>
                </div>

                <div class="filter-bar" style="margin-bottom: 24px;">
                    <div class="filter-btn active" onclick="filterSubmissions('all')">All</div>
                    <div class="filter-btn" onclick="filterSubmissions('rates')">Rate Submissions</div>
                    <div class="filter-btn" onclick="filterSubmissions('bugs')">Bug Reports</div>
                    <div class="filter-btn" onclick="filterSubmissions('feedback')">User Feedback</div>
                </div>
                <div class="table-container">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 style="margin: 0;">Submissions</h3>
                        <button 
                            onclick="exportSubmissionsCSV()" 
                            style="padding: 10px 20px; background: rgba(255, 255, 255, 0.8); border: 1px solid #e2e8f0; border-radius: 10px; color: #1e293b; font-size: 14px; font-weight: 500; cursor: pointer; font-family: 'Inter', sans-serif; transition: all 0.3s;"
                            onmouseover="this.style.background='rgba(255, 255, 255, 0.25)'"
                            onmouseout="this.style.background='rgba(255, 255, 255, 0.15)'"
                        >
                            Export CSV
                        </button>
                    </div>
                    <div id="submissionsList">
                        <div class="loading">Loading...</div>
                    </div>
                </div>
            </div>

            <!-- Waitlist Tab -->
            <div id="waitlist" class="content">
                <div class="content-header">
                    <h2>Waitlist Signups</h2>
                    <p>Monitor new leads from the marketing site waitlist</p>
                </div>

                <div class="stats-grid" style="margin-bottom: 30px;">
                    <div class="stat-card">
                        <h3>Total Waitlist</h3>
                        <div class="value" id="waitlistTotalCount">-</div>
                        <div class="label">All signups</div>
                    </div>
                    <div class="stat-card">
                        <h3>Last 24 Hours</h3>
                        <div class="value" id="waitlist24hCount">-</div>
                        <div class="label">Recent signups</div>
                    </div>
                    <div class="stat-card">
                        <h3>Top Source</h3>
                        <div class="value" id="waitlistTopSource">-</div>
                        <div class="label">Most common source</div>
                    </div>
                </div>

                <div class="table-container">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 style="margin: 0;">All Waitlist Signups</h3>
                        <button 
                            onclick="exportWaitlistCSV()" 
                            style="padding: 10px 20px; background: rgba(255, 255, 255, 0.8); border: 1px solid #e2e8f0; border-radius: 10px; color: #1e293b; font-size: 14px; font-weight: 500; cursor: pointer; font-family: 'Inter', sans-serif; transition: all 0.3s;"
                            onmouseover="this.style.background='rgba(255, 255, 255, 0.25)'"
                            onmouseout="this.style.background='rgba(255, 255, 255, 0.15)'"
                        >
                            Export CSV
                        </button>
                    </div>
                    <div id="waitlistList">
                        <div class="loading">Loading waitlist...</div>
                    </div>
                </div>
            </div>

            <!-- Analytics Tab -->
            <div id="analytics" class="content">
                <div class="content-header">
                    <h2>Analytics</h2>
                    <p>User analytics and platform distribution</p>
                </div>
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3>Total Users</h3>
                        <div class="value" id="totalUsers">-</div>
                    </div>
                    <div class="stat-card">
                        <h3>Paid Users</h3>
                        <div class="value" id="paidUsers">-</div>
                    </div>
                    <div class="stat-card">
                        <h3>Subscription Revenue</h3>
                        <div class="value" id="subscriptionRevenue">-</div>
                    </div>
                    <div class="stat-card">
                        <h3>Conversion Rate</h3>
                        <div class="value" id="conversionRate">-</div>
                    </div>
                </div>
                <div class="table-container">
                    <h3>Platform Distribution</h3>
                    <div id="platformDistribution">
                        <div class="loading">Loading...</div>
                    </div>
                </div>
            </div>

            <!-- Email History Tab -->
            <div id="email-history" class="content">
                <div class="content-header">
                    <h2>Email History</h2>
                    <p>View all sent emails and their status</p>
                </div>

                <div style="display: flex; gap: 16px; margin-bottom: 24px; flex-wrap: wrap;">
                    <select id="emailHistoryType" onchange="loadEmailHistory()"
                        style="padding: 10px 16px; border: 1px solid #e2e8f0; border-radius: 10px; background: #ffffff; color: #1e293b; font-size: 14px; font-family: 'Inter', sans-serif; cursor: pointer;">
                        <option value="all">All Types</option>
                        <option value="individual">Individual</option>
                        <option value="welcome">Welcome</option>
                        <option value="bulk">Bulk</option>
                        <option value="marketing">Marketing</option>
                    </select>
                    <select id="emailHistoryStatus" onchange="loadEmailHistory()"
                        style="padding: 10px 16px; border: 1px solid #e2e8f0; border-radius: 10px; background: #ffffff; color: #1e293b; font-size: 14px; font-family: 'Inter', sans-serif; cursor: pointer;">
                        <option value="all">All Status</option>
                        <option value="sent">Sent</option>
                        <option value="failed">Failed</option>
                    </select>
                    <input type="text" id="emailHistorySearch" placeholder="Search by email or subject..." onkeyup="loadEmailHistory()"
                        style="flex: 1; min-width: 200px; padding: 10px 16px; border: 1px solid #e2e8f0; border-radius: 10px; background: #ffffff; color: #1e293b; font-size: 14px; font-family: 'Inter', sans-serif;">
                </div>

                <div class="table-container">
                    <div id="emailHistoryList">
                        <div class="loading">Loading email history...</div>
                    </div>
                </div>
            </div>

            <!-- Send Email Tab -->
            <div id="send-email" class="content">
                <div class="content-header">
                    <h2>Send Email</h2>
                    <p>Send individual emails to users</p>
                </div>

                <div style="background: rgba(255, 255, 255, 0.8); border: 1px solid #e2e8f0; border-radius: 16px; padding: 32px; max-width: 800px;">
                    <div id="emailSuccess" class="email-success" style="display: none; margin-bottom: 20px; padding: 12px; background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.3); border-radius: 8px; color: #10b981; font-size: 14px;"></div>
                    <form id="emailForm" onsubmit="sendEmail(event)">
                        <div class="email-form-group">
                            <label for="emailTo">To (Email Address)</label>
                            <input 
                                type="email" 
                                id="emailTo" 
                                required
                                placeholder="user@example.com"
                            />
                        </div>
                        <div class="email-form-group">
                            <label for="emailSubject">Subject</label>
                            <input 
                                type="text" 
                                id="emailSubject" 
                                required
                                placeholder="Email subject"
                            />
                        </div>
                        <div class="email-form-group">
                            <label for="emailMessage">Message</label>
                            <textarea 
                                id="emailMessage" 
                                required
                                placeholder="Enter your message here..."
                                rows="10"
                            ></textarea>
                        </div>
                        <div style="display: flex; align-items: center; gap: 12px; padding: 16px; background: rgba(249, 115, 22, 0.1); border: 1px solid rgba(249, 115, 22, 0.3); border-radius: 10px; margin-bottom: 20px;">
                            <input type="checkbox" id="emailUseHtml" checked style="width: 20px; height: 20px; cursor: pointer;">
                            <label for="emailUseHtml" style="color: #1e293b; font-size: 14px; font-weight: 500; cursor: pointer; flex: 1;">
                                Use branded HTML template (includes ORA logo and styling)
                            </label>
                        </div>
                        <div class="email-modal-actions">
                            <button type="submit" class="email-submit-btn">
                                Send Email
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Welcome Emails Tab -->
            <div id="welcome-emails" class="content">
                <div class="content-header">
                    <h2>Welcome Emails</h2>
                    <p>Create and send welcome emails to new users</p>
                </div>

                <div style="background: rgba(255, 255, 255, 0.8); border: 1px solid #e2e8f0; border-radius: 16px; padding: 32px; margin-bottom: 32px;">
                    <h3 style="font-family: 'Manrope', sans-serif; font-size: 20px; color: #1e293b; margin-bottom: 20px;">Welcome Email Template</h3>
                    
                    <form id="welcomeEmailForm" style="display: flex; flex-direction: column; gap: 20px;">
                        <div style="display: flex; align-items: center; gap: 12px; padding: 16px; background: rgba(249, 115, 22, 0.1); border: 1px solid rgba(249, 115, 22, 0.3); border-radius: 10px;">
                            <input type="checkbox" id="welcomeEmailAutoSend" style="width: 20px; height: 20px; cursor: pointer;">
                            <label for="welcomeEmailAutoSend" style="color: #1e293b; font-size: 14px; font-weight: 500; cursor: pointer; flex: 1;">
                                Automatically send welcome email when users sign up
                            </label>
                        </div>

                        <div>
                            <label style="display: block; color: #1e293b; font-size: 14px; font-weight: 500; margin-bottom: 8px;">Subject *</label>
                            <input type="text" id="welcomeEmailSubject" value="Welcome to ORA!" required
                                style="width: 100%; padding: 12px 16px; border: 1px solid #e2e8f0; border-radius: 10px; background: #ffffff; color: #1e293b; font-size: 15px; font-family: 'Inter', sans-serif;">
                        </div>

                        <div>
                            <label style="display: block; color: #1e293b; font-size: 14px; font-weight: 500; margin-bottom: 8px;">Message *</label>
                            <textarea id="welcomeEmailMessage" required rows="12"
                                style="width: 100%; padding: 12px 16px; border: 1px solid #e2e8f0; border-radius: 10px; background: #ffffff; color: #1e293b; font-size: 15px; font-family: 'Inter', sans-serif; resize: vertical;">Hi {{displayName}},

Welcome to ORA! We're thrilled to have you join our community of creators who are taking control of their business.

Since you're already in the app, you're all set to start using ORA's powerful features. Here's what you can do:

 Calculate fair rates for your work with our smart rate calculator
 Track and manage all your brand deals in one place
 Generate professional quotes and media kits to send to brands
 Analyze contracts before you sign to protect your rights
 Build and maintain your brand partnerships with our brand vault
 Track your revenue across all platforms and collaborations
 See real reviews from other creators about brands and agencies
 Never miss a deal with our opportunity pipeline
 And many more features to streamline your creator business

We're constantly improving ORA based on feedback from creators like you. If you have any questions, ideas, or need help, just reply to this email. we're here for you.

Ready to take your creator business to the next level? Explore the app and start managing your deals today!

Best,

The ORA Team

 2025 ORA. All rights reserved.

Visit us at https://myora.co</textarea>
                            <p style="color: #64748b; font-size: 12px; margin-top: 8px;">Use {{displayName}} to personalize the email with the user's name</p>
                        </div>

                        <div style="display: flex; align-items: center; gap: 12px; padding: 16px; background: rgba(249, 115, 22, 0.1); border: 1px solid rgba(249, 115, 22, 0.3); border-radius: 10px;">
                            <input type="checkbox" id="welcomeEmailUseHtml" checked style="width: 20px; height: 20px; cursor: pointer;">
                            <label for="welcomeEmailUseHtml" style="color: #1e293b; font-size: 14px; font-weight: 500; cursor: pointer; flex: 1;">
                                Use branded HTML template (includes ORA logo and styling)
                            </label>
                        </div>

                        <div style="display: flex; gap: 12px; align-items: center;">
                            <button type="button" onclick="saveWelcomeEmailTemplate()"
                                style="flex: 1; padding: 14px; background: #f97316; border: 1px solid #f97316; border-radius: 10px; color: #ffffff; font-size: 15px; font-weight: 600; cursor: pointer; font-family: 'Inter', sans-serif; transition: all 0.3s;"
                                onmouseover="this.style.background='#ea580c'"
                                onmouseout="this.style.background='#f97316'">
                                Save Template
                            </button>
                            <button type="button" onclick="previewWelcomeEmail()"
                                style="padding: 14px 24px; background: rgba(255, 255, 255, 0.8); border: 1px solid #e2e8f0; border-radius: 10px; color: #1e293b; font-size: 15px; font-weight: 500; cursor: pointer; font-family: 'Inter', sans-serif; transition: all 0.3s;">
                                Preview
                            </button>
                        </div>
                    </form>
                </div>

                <div style="background: rgba(255, 255, 255, 0.8); border: 1px solid #e2e8f0; border-radius: 16px; padding: 32px;">
                    <h3 style="font-family: 'Manrope', sans-serif; font-size: 20px; color: #1e293b; margin-bottom: 20px;">Send Welcome Email</h3>
                    <div style="display: flex; flex-direction: column; gap: 16px;">
                        <div>
                            <label style="display: block; color: #1e293b; font-size: 14px; font-weight: 500; margin-bottom: 8px;">User Email *</label>
                            <input type="email" id="welcomeEmailTo" placeholder="user@example.com" required
                                style="width: 100%; padding: 12px 16px; border: 1px solid #e2e8f0; border-radius: 10px; background: #ffffff; color: #1e293b; font-size: 15px; font-family: 'Inter', sans-serif;">
                        </div>
                        <button type="button" onclick="sendWelcomeEmailToUser()"
                            style="padding: 14px; background: #f97316; border: 1px solid #f97316; border-radius: 10px; color: #ffffff; font-size: 15px; font-weight: 600; cursor: pointer; font-family: 'Inter', sans-serif; transition: all 0.3s;"
                            onmouseover="this.style.background='#ea580c'"
                            onmouseout="this.style.background='#f97316'">
                            Send Welcome Email
                        </button>
                    </div>
                </div>
            </div>

            <!-- Creator Pool Tab -->
            <div id="creator-pool" class="content">
                <div class="content-header">
                    <h2>Creator Pool</h2>
                    <p>Manage your list of creators for marketing campaigns - stored locally in your browser</p>
                </div>

                <div style="background: rgba(255, 255, 255, 0.8); border: 1px solid #e2e8f0; border-radius: 16px; padding: 32px; margin-bottom: 32px;">
                    <h3 style="font-family: 'Manrope', sans-serif; font-size: 20px; color: #1e293b; margin-bottom: 20px;">Add Creator</h3>
                    
                    <form id="creatorPoolForm" style="display: flex; flex-direction: column; gap: 16px;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                            <div>
                                <label style="display: block; color: #1e293b; font-size: 14px; font-weight: 500; margin-bottom: 8px;">Name / Display Name *</label>
                                <input type="text" id="creatorName" placeholder="e.g., Sarah Johnson" required
                                    style="width: 100%; padding: 12px 16px; border: 1px solid #e2e8f0; border-radius: 10px; background: #ffffff; color: #1e293b; font-size: 15px; font-family: 'Inter', sans-serif;">
                            </div>
                            <div>
                                <label style="display: block; color: #1e293b; font-size: 14px; font-weight: 500; margin-bottom: 8px;">Email Address *</label>
                                <input type="email" id="creatorEmail" placeholder="creator@example.com" required
                                    style="width: 100%; padding: 12px 16px; border: 1px solid #e2e8f0; border-radius: 10px; background: #ffffff; color: #1e293b; font-size: 15px; font-family: 'Inter', sans-serif;">
                            </div>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px;">
                            <div>
                                <label style="display: block; color: #1e293b; font-size: 14px; font-weight: 500; margin-bottom: 8px;">Instagram Handle</label>
                                <input type="text" id="creatorInstagram" placeholder="@username"
                                    style="width: 100%; padding: 12px 16px; border: 1px solid #e2e8f0; border-radius: 10px; background: #ffffff; color: #1e293b; font-size: 15px; font-family: 'Inter', sans-serif;">
                            </div>
                            <div>
                                <label style="display: block; color: #1e293b; font-size: 14px; font-weight: 500; margin-bottom: 8px;">TikTok Handle</label>
                                <input type="text" id="creatorTikTok" placeholder="@username"
                                    style="width: 100%; padding: 12px 16px; border: 1px solid #e2e8f0; border-radius: 10px; background: #ffffff; color: #1e293b; font-size: 15px; font-family: 'Inter', sans-serif;">
                            </div>
                            <div>
                                <label style="display: block; color: #1e293b; font-size: 14px; font-weight: 500; margin-bottom: 8px;">YouTube Channel</label>
                                <input type="text" id="creatorYouTube" placeholder="Channel name or URL"
                                    style="width: 100%; padding: 12px 16px; border: 1px solid #e2e8f0; border-radius: 10px; background: #ffffff; color: #1e293b; font-size: 15px; font-family: 'Inter', sans-serif;">
                            </div>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                            <div>
                                <label style="display: block; color: #1e293b; font-size: 14px; font-weight: 500; margin-bottom: 8px;">Twitter/X Handle</label>
                                <input type="text" id="creatorTwitter" placeholder="@username"
                                    style="width: 100%; padding: 12px 16px; border: 1px solid #e2e8f0; border-radius: 10px; background: #ffffff; color: #1e293b; font-size: 15px; font-family: 'Inter', sans-serif;">
                            </div>
                            <div>
                                <label style="display: block; color: #1e293b; font-size: 14px; font-weight: 500; margin-bottom: 8px;">Other Social Media</label>
                                <input type="text" id="creatorOther" placeholder="Other platforms or notes"
                                    style="width: 100%; padding: 12px 16px; border: 1px solid #e2e8f0; border-radius: 10px; background: #ffffff; color: #1e293b; font-size: 15px; font-family: 'Inter', sans-serif;">
                            </div>
                        </div>

                        <div>
                            <label style="display: block; color: #1e293b; font-size: 14px; font-weight: 500; margin-bottom: 8px;">Notes (optional)</label>
                            <textarea id="creatorNotes" placeholder="Any additional notes about this creator..." rows="3"
                                style="width: 100%; padding: 12px 16px; border: 1px solid #e2e8f0; border-radius: 10px; background: #ffffff; color: #1e293b; font-size: 15px; font-family: 'Inter', sans-serif; resize: vertical;"></textarea>
                        </div>

                        <div style="display: flex; gap: 12px; align-items: center;">
                            <button type="submit" 
                                style="flex: 1; padding: 14px; background: #f97316; border: 1px solid #f97316; border-radius: 10px; color: #ffffff; font-size: 15px; font-weight: 600; cursor: pointer; font-family: 'Inter', sans-serif; transition: all 0.3s;"
                                onmouseover="this.style.background='#ea580c'"
                                onmouseout="this.style.background='#f97316'">
                                Add Creator
                            </button>
                            <button type="button" onclick="exportCreatorPoolCSV()" 
                                style="padding: 14px 24px; background: rgba(255, 255, 255, 0.8); border: 1px solid #e2e8f0; border-radius: 10px; color: #1e293b; font-size: 15px; font-weight: 500; cursor: pointer; font-family: 'Inter', sans-serif; transition: all 0.3s;">
                                Export CSV
                            </button>
                        </div>
                    </form>
                </div>

                <div class="table-container">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 style="margin: 0;">Creator Pool (<span id="creatorPoolCount">0</span> creators) - <span id="selectedCreatorsCount">0</span> selected for emails</h3>
                        <div style="display: flex; gap: 12px;">
                            <button onclick="toggleAllCreatorsSelected()" 
                                style="padding: 10px 20px; background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.3); border-radius: 8px; color: #3b82f6; font-size: 14px; font-weight: 500; cursor: pointer; font-family: 'Inter', sans-serif; transition: all 0.3s;"
                                onmouseover="this.style.background='rgba(59, 130, 246, 0.2)'"
                                onmouseout="this.style.background='rgba(59, 130, 246, 0.1)'">
                                Select All
                            </button>
                            <input type="text" id="creatorPoolSearch" placeholder="Search creators..." 
                                style="padding: 10px 16px; border: 1px solid #e2e8f0; border-radius: 8px; background: #ffffff; color: #1e293b; font-size: 14px; font-family: 'Inter', sans-serif; width: 250px;"
                                oninput="filterCreatorPool()">
                            <button onclick="clearCreatorPool()" 
                                style="padding: 10px 20px; background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 8px; color: #ef4444; font-size: 14px; font-weight: 500; cursor: pointer; font-family: 'Inter', sans-serif; transition: all 0.3s;"
                                onmouseover="this.style.background='rgba(239, 68, 68, 0.2)'"
                                onmouseout="this.style.background='rgba(239, 68, 68, 0.1)'">
                                Clear All
                            </button>
                        </div>
                    </div>
                    <div id="creatorPoolList">
                        <div class="loading">Loading creator pool...</div>
                    </div>
                </div>
            </div>

            <!-- Bulk Email Tab -->
            <div id="bulk-email" class="content">
                <div class="content-header">
                    <h2>Bulk Email</h2>
                    <p>Send emails to multiple users individually (recipients won't see each other's emails)</p>
                </div>

                <!-- Two Column Layout: Form + Live Preview -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-bottom: 32px;">
                    <!-- Left Column: Email Form -->
                    <div style="background: rgba(255, 255, 255, 0.8); border: 1px solid #e2e8f0; border-radius: 16px; padding: 32px;">
                    <h3 style="font-family: 'Manrope', sans-serif; font-size: 20px; color: #1e293b; margin-bottom: 20px;">Compose Bulk Email</h3>
                        
                        <!-- Quick Templates -->
                        <div style="background: rgba(249, 115, 22, 0.1); border: 1px solid rgba(249, 115, 22, 0.3); border-radius: 12px; padding: 16px; margin-bottom: 24px;">
                            <p style="color: #1e293b; font-size: 14px; font-weight: 600; margin: 0 0 12px 0;">Quick Templates:</p>
                            <button type="button" onclick="loadAppStoreLaunchEmail()" 
                                    style="padding: 10px 20px; background: #f97316; border: 1px solid #f97316; border-radius: 8px; color: #ffffff; font-size: 14px; font-weight: 600; cursor: pointer; font-family: 'Inter', sans-serif; transition: all 0.3s;"
                                    onmouseover="this.style.background='#ea580c'"
                                    onmouseout="this.style.background='#f97316'">
                                 Load App Store Launch Email
                            </button>
                        </div>
                    
                    <form id="bulkEmailForm" style="display: flex; flex-direction: column; gap: 20px;">
                        <div>
                            <label style="display: block; color: #1e293b; font-size: 14px; font-weight: 500; margin-bottom: 8px;">Subject *</label>
                            <input type="text" id="bulkEmailSubject" placeholder="e.g., Early Access Invitation" required
                                style="width: 100%; padding: 12px 16px; border: 1px solid #e2e8f0; border-radius: 10px; background: #ffffff; color: #1e293b; font-size: 15px; font-family: 'Inter', sans-serif;">
                        </div>

                        <div>
                            <label style="display: block; color: #1e293b; font-size: 14px; font-weight: 500; margin-bottom: 8px;">Message *</label>
                            <textarea id="bulkEmailMessage" placeholder="Write your email message here. Use {{displayName}} to personalize with each user's name." required rows="10"
                                style="width: 100%; padding: 12px 16px; border: 1px solid #e2e8f0; border-radius: 10px; background: #ffffff; color: #1e293b; font-size: 15px; font-family: 'Inter', sans-serif; resize: vertical;"></textarea>
                            <p style="color: #64748b; font-size: 12px; margin-top: 8px;">Use {{displayName}} to personalize the email with each user's name. Each email will be sent individually so recipients won't see each other's addresses.</p>
                        </div>

                        <div style="display: flex; align-items: center; gap: 12px; padding: 16px; background: rgba(249, 115, 22, 0.1); border: 1px solid rgba(249, 115, 22, 0.3); border-radius: 10px;">
                            <input type="checkbox" id="bulkEmailUseHtml" checked style="width: 20px; height: 20px; cursor: pointer;">
                            <label for="bulkEmailUseHtml" style="color: #1e293b; font-size: 14px; font-weight: 500; cursor: pointer; flex: 1;">
                                Use branded HTML template (includes ORA logo and styling)
                            </label>
                        </div>

                        <div>
                            <label style="display: block; color: #1e293b; font-size: 14px; font-weight: 500; margin-bottom: 8px;">App Store URL (optional - for App Store launch emails)</label>
                            <input type="url" id="appStoreUrl" placeholder="https://apps.apple.com/us/app/my-ora/id6755090210" value="https://apps.apple.com/us/app/my-ora/id6755090210"
                                style="width: 100%; padding: 12px 16px; border: 1px solid #e2e8f0; border-radius: 10px; background: #ffffff; color: #1e293b; font-size: 15px; font-family: 'Inter', sans-serif;">
                            <p style="color: #64748b; font-size: 12px; margin-top: 8px;">Your App Store link is pre-filled. Use [App Store] in your message to create the official download badge.</p>
                        </div>

                        <div>
                            <label style="display: block; color: #1e293b; font-size: 14px; font-weight: 500; margin-bottom: 12px;">Recipients</label>
                            <div style="display: flex; flex-direction: column; gap: 12px;">
                                <label style="display: flex; align-items: center; gap: 12px; padding: 12px; background: rgba(255, 255, 255, 0.5); border: 1px solid #e2e8f0; border-radius: 8px; cursor: pointer;">
                                    <input type="radio" name="bulkEmailRecipients" value="all" checked style="width: 18px; height: 18px; cursor: pointer;">
                                    <span style="color: #1e293b; font-size: 14px;">All users (<span id="allUsersCount">-</span> users)</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 12px; padding: 12px; background: rgba(255, 255, 255, 0.5); border: 1px solid #e2e8f0; border-radius: 8px; cursor: pointer;">
                                    <input type="radio" name="bulkEmailRecipients" value="subscribed" style="width: 18px; height: 18px; cursor: pointer;">
                                    <span style="color: #1e293b; font-size: 14px;">Subscribed users only (<span id="subscribedUsersCount">-</span> users)</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 12px; padding: 12px; background: rgba(255, 255, 255, 0.5); border: 1px solid #e2e8f0; border-radius: 8px; cursor: pointer;">
                                    <input type="radio" name="bulkEmailRecipients" value="free" style="width: 18px; height: 18px; cursor: pointer;">
                                    <span style="color: #1e293b; font-size: 14px;">Free users only (<span id="freeUsersCount">-</span> users)</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 12px; padding: 12px; background: rgba(255, 255, 255, 0.5); border: 1px solid #e2e8f0; border-radius: 8px; cursor: pointer;">
                                    <input type="radio" name="bulkEmailRecipients" value="custom" style="width: 18px; height: 18px; cursor: pointer;">
                                    <span style="color: #1e293b; font-size: 14px;">Custom selection from users</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 12px; padding: 12px; background: rgba(255, 255, 255, 0.5); border: 1px solid #e2e8f0; border-radius: 8px; cursor: pointer;">
                                    <input type="radio" name="bulkEmailRecipients" value="creator-pool" style="width: 18px; height: 18px; cursor: pointer;">
                                    <span style="color: #1e293b; font-size: 14px;">Creator Pool (<span id="creatorPoolRecipientsCount">0</span> creators)</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 12px; padding: 12px; background: rgba(255, 255, 255, 0.5); border: 1px solid #e2e8f0; border-radius: 8px; cursor: pointer;">
                                    <input type="radio" name="bulkEmailRecipients" value="manual" style="width: 18px; height: 18px; cursor: pointer;">
                                    <span style="color: #1e293b; font-size: 14px;">Manual email list (paste emails)</span>
                                </label>
                            </div>
                        </div>

                        <div id="creatorPoolRecipientsSection" style="display: none;">
                            <label style="display: block; color: #1e293b; font-size: 14px; font-weight: 500; margin-bottom: 8px;">Select Creators from Pool</label>
                            <div style="background: rgba(249, 115, 22, 0.05); border: 1px solid rgba(249, 115, 22, 0.2); border-radius: 8px; padding: 12px; margin-bottom: 12px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                    <p style="color: #64748b; font-size: 12px; margin: 0;">Select which creators to email. Only checked creators will receive the email.</p>
                                    <button type="button" onclick="toggleAllCreatorPoolRecipients()" 
                                        style="padding: 6px 12px; background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.3); border-radius: 6px; color: #3b82f6; font-size: 12px; font-weight: 500; cursor: pointer; font-family: 'Inter', sans-serif;">
                                        Select All
                                    </button>
                                </div>
                            </div>
                            <div id="creatorPoolRecipientsList" style="max-height: 300px; overflow-y: auto; border: 1px solid #e2e8f0; border-radius: 8px; padding: 12px; background: #ffffff;">
                                <div class="loading">Loading creator pool...</div>
                            </div>
                        </div>

                        <div id="customRecipientsSection" style="display: none;">
                            <label style="display: block; color: #1e293b; font-size: 14px; font-weight: 500; margin-bottom: 8px;">Select Users</label>
                            <div id="bulkEmailUserList" style="max-height: 200px; overflow-y: auto; border: 1px solid #e2e8f0; border-radius: 8px; padding: 12px; background: #ffffff;">
                                <div class="loading">Loading users...</div>
                            </div>
                        </div>

                        <div id="manualRecipientsSection" style="display: none;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                <label style="display: block; color: #1e293b; font-size: 14px; font-weight: 500;">Email Addresses *</label>
                                <button type="button" onclick="addEmailInput()"
                                    style="padding: 8px 16px; background: #3b82f6; border: 1px solid #3b82f6; border-radius: 8px; color: #ffffff; font-size: 13px; font-weight: 500; cursor: pointer; font-family: 'Inter', sans-serif; transition: all 0.3s;"
                                    onmouseover="this.style.background='#2563eb'"
                                    onmouseout="this.style.background='#3b82f6'">
                                    + Add Email
                                </button>
                            </div>
                            <div id="bulkEmailManualInputs" style="display: flex; flex-direction: column; gap: 8px; max-height: 400px; overflow-y: auto; padding: 12px; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 10px;">
                                <div style="display: flex; gap: 8px; align-items: center;">
                                    <input type="email" class="bulk-email-manual-input" placeholder="email@example.com"
                                        style="flex: 1; padding: 10px 14px; border: 1px solid #e2e8f0; border-radius: 8px; background: #ffffff; color: #1e293b; font-size: 14px; font-family: 'Inter', sans-serif;">
                                    <button type="button" onclick="removeEmailInput(this)" style="padding: 10px 14px; background: #ef4444; border: 1px solid #ef4444; border-radius: 8px; color: #ffffff; font-size: 13px; font-weight: 500; cursor: pointer; font-family: 'Inter', sans-serif; transition: all 0.3s;"
                                        onmouseover="this.style.background='#dc2626'"
                                        onmouseout="this.style.background='#ef4444'">Remove</button>
                                </div>
                            </div>
                            <p style="color: #64748b; font-size: 12px; margin-top: 8px;">Add email addresses one at a time. Each email will be sent individually so recipients won't see each other's addresses.</p>
                        </div>

                        <div style="display: flex; gap: 12px; align-items: center;">
                            <button type="button" onclick="sendBulkEmail()"
                                style="flex: 1; padding: 14px; background: #f97316; border: 1px solid #f97316; border-radius: 10px; color: #ffffff; font-size: 15px; font-weight: 600; cursor: pointer; font-family: 'Inter', sans-serif; transition: all 0.3s;"
                                onmouseover="this.style.background='#ea580c'"
                                onmouseout="this.style.background='#f97316'">
                                Send Bulk Email
                            </button>
                            <button type="button" onclick="previewBulkEmail()"
                                style="padding: 14px 24px; background: rgba(255, 255, 255, 0.8); border: 1px solid #e2e8f0; border-radius: 10px; color: #1e293b; font-size: 15px; font-weight: 500; cursor: pointer; font-family: 'Inter', sans-serif; transition: all 0.3s;">
                                Preview
                            </button>
                        </div>
                    </form>
                    </div>

                    <!-- Right Column: Live Email Preview -->
                    <div style="background: rgba(255, 255, 255, 0.8); border: 1px solid #e2e8f0; border-radius: 16px; padding: 32px; position: sticky; top: 20px; max-height: calc(100vh - 40px); overflow-y: auto;">
                        <h3 style="font-family: 'Manrope', sans-serif; font-size: 20px; color: #1e293b; margin-bottom: 20px;"> Live Preview</h3>
                        <p style="color: #64748b; font-size: 12px; margin-bottom: 16px;">Preview updates as you type</p>
                        <div id="emailLivePreview" style="border: 1px solid #e2e8f0; border-radius: 12px; overflow: hidden; background: #f5f5f7; min-height: 400px;">
                            <div style="padding: 40px; text-align: center; color: #94a3b8;">
                                <p>Start typing to see preview...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div style="background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.3); border-radius: 16px; padding: 24px; margin-top: 32px;">
                    <h4 style="font-family: 'Manrope', sans-serif; font-size: 18px; color: #1e293b; margin-bottom: 12px;">How It Works</h4>
                    <ul style="color: #1e293b; font-size: 14px; line-height: 1.8; padding-left: 20px;">
                        <li><strong>Individual Sends:</strong> Each email is sent separately, so recipients won't see each other's email addresses</li>
                        <li><strong>Personalization:</strong> Use {{displayName}} in your message to personalize each email</li>
                        <li><strong>Privacy:</strong> All emails are sent individually (not in a group), ensuring complete privacy</li>
                        <li><strong>Progress:</strong> You'll see a progress indicator as emails are sent</li>
                        <li><strong>Rate Limiting:</strong> Emails are sent in batches to avoid overwhelming the email server</li>
                    </ul>
                </div>
            </div>

            <!-- Marketing Tab -->
            <div id="marketing" class="content">
                <div class="content-header">
                    <h2>Marketing Notifications</h2>
                    <p>Send marketing updates, tips, and industry insights to users who have opted in</p>
                </div>

                <div style="background: rgba(255, 255, 255, 0.8); border: 1px solid #e2e8f0; border-radius: 16px; padding: 32px; margin-bottom: 32px;">
                    <h3 style="font-family: 'Manrope', sans-serif; font-size: 20px; color: #1e293b; margin-bottom: 20px;">Create Marketing Notification</h3>
                    
                    <form id="marketingForm" style="display: flex; flex-direction: column; gap: 20px;">
                        <div>
                            <label style="display: block; color: #1e293b; font-size: 14px; font-weight: 500; margin-bottom: 8px;">Title *</label>
                            <input type="text" id="marketingTitle" placeholder="e.g., New Feature: Brand Vault Updates" required
                                style="width: 100%; padding: 12px 16px; border: 1px solid #e2e8f0; border-radius: 10px; background: #ffffff; color: #1e293b; font-size: 15px; font-family: 'Inter', sans-serif;">
                        </div>

                        <div>
                            <label style="display: block; color: #1e293b; font-size: 14px; font-weight: 500; margin-bottom: 8px;">Message *</label>
                            <textarea id="marketingMessage" placeholder="Write your marketing message here. Keep it concise and engaging..." required rows="6"
                                style="width: 100%; padding: 12px 16px; border: 1px solid #e2e8f0; border-radius: 10px; background: #ffffff; color: #1e293b; font-size: 15px; font-family: 'Inter', sans-serif; resize: vertical;"></textarea>
                        </div>

                        <div>
                            <label style="display: block; color: #1e293b; font-size: 14px; font-weight: 500; margin-bottom: 8px;">Type</label>
                            <select id="marketingType" style="width: 100%; padding: 12px 16px; border: 1px solid #e2e8f0; border-radius: 10px; background: #ffffff; color: #1e293b; font-size: 15px; font-family: 'Inter', sans-serif;">
                                <option value="tip">Tip</option>
                                <option value="update">Update</option>
                                <option value="feature">New Feature</option>
                                <option value="industry_news">Industry News</option>
                                <option value="promotion">Promotion</option>
                            </select>
                        </div>

                        <div style="display: flex; gap: 12px; align-items: center;">
                            <button type="submit" 
                                style="flex: 1; padding: 14px; background: #f97316; border: 1px solid #f97316; border-radius: 10px; color: #ffffff; font-size: 15px; font-weight: 600; cursor: pointer; font-family: 'Inter', sans-serif; transition: all 0.3s;"
                                onmouseover="this.style.background='rgba(255, 255, 255, 0.25)'; this.style.borderColor='rgba(255, 255, 255, 0.5)'"
                                onmouseout="this.style.background='rgba(255, 255, 255, 0.15)'; this.style.borderColor='rgba(255, 255, 255, 0.3)'">
                                Send Notification
                            </button>
                            <button type="button" onclick="previewMarketingNotification()"
                                style="padding: 14px 24px; background: rgba(255, 255, 255, 0.8); border: 1px solid #e2e8f0; border-radius: 10px; color: #1e293b; font-size: 15px; font-weight: 500; cursor: pointer; font-family: 'Inter', sans-serif; transition: all 0.3s;"
                                onmouseover="this.style.background='rgba(255, 255, 255, 0.08)'; this.style.borderColor='rgba(255, 255, 255, 0.3)'"
                                onmouseout="this.style.background='rgba(255, 255, 255, 0.05)'; this.style.borderColor='rgba(255, 255, 255, 0.2)'">
                                Preview
                            </button>
                        </div>
                    </form>
                </div>

                <div style="background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 16px; padding: 32px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                        <h3 style="font-family: 'Manrope', sans-serif; font-size: 20px; color: #1e293b;">Recent Marketing Notifications</h3>
                        <button onclick="loadMarketing()" 
                            style="padding: 10px 20px; background: rgba(255, 255, 255, 0.8); border: 1px solid #e2e8f0; border-radius: 10px; color: #1e293b; font-size: 14px; font-weight: 500; cursor: pointer; font-family: 'Inter', sans-serif; transition: all 0.3s;"
                            onmouseover="this.style.background='rgba(255, 255, 255, 0.08)'"
                            onmouseout="this.style.background='rgba(255, 255, 255, 0.05)'">
                            Refresh
                        </button>
                    </div>
                    <div id="marketingHistory" style="display: flex; flex-direction: column; gap: 16px;">
                        <div class="empty-state">Loading marketing history...</div>
                    </div>
                </div>

                <div style="background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.3); border-radius: 16px; padding: 24px; margin-top: 32px;">
                    <h4 style="font-family: 'Manrope', sans-serif; font-size: 18px; color: #1e293b; margin-bottom: 12px;">Best Practices</h4>
                    <ul style="color: #1e293b; font-size: 14px; line-height: 1.8; padding-left: 20px;">
                        <li><strong>Frequency:</strong> Send 1-2 marketing notifications per week maximum to avoid user fatigue</li>
                        <li><strong>Timing:</strong> Best times are Tuesday-Thursday, 10 AM - 2 PM in your users' timezone</li>
                        <li><strong>Content:</strong> Keep messages concise (under 100 characters for title, under 200 for message)</li>
                        <li><strong>Value:</strong> Focus on tips, new features, or industry insights that provide real value</li>
                        <li><strong>Segmentation:</strong> Consider sending different messages to free vs. paid users</li>
                        <li><strong>Testing:</strong> Preview before sending to ensure formatting looks good</li>
                    </ul>
                </div>
            </div>

            <!-- Errors Tab -->
            <div id="errors" class="content">
                <div class="content-header">
                    <h2>Real-Time Error Monitoring</h2>
                    <p>Live errors, console errors, and app crashes from all users</p>
                </div>

                <div class="stats-grid" style="margin-bottom: 30px;">
                    <div class="stat-card" style="background: linear-gradient(135deg, rgba(255, 59, 48, 0.15) 0%, rgba(255, 59, 48, 0.05) 100%); border: 1px solid rgba(255, 59, 48, 0.2);">
                        <h3>Total Errors</h3>
                        <div class="value" id="totalErrors" style="color: #ff3b30;">-</div>
                        <div class="label">All errors tracked</div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, rgba(255, 107, 107, 0.15) 0%, rgba(255, 107, 107, 0.05) 100%); border: 1px solid rgba(255, 107, 107, 0.2);">
                        <h3>Critical Errors</h3>
                        <div class="value" id="criticalErrors" style="color: #ff6b6b;">-</div>
                        <div class="label">Requires immediate attention</div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, rgba(16, 185, 129, 0.15) 0%, rgba(16, 185, 129, 0.05) 100%); border: 1px solid rgba(16, 185, 129, 0.2);">
                        <h3>Resolved</h3>
                        <div class="value" id="resolvedErrors" style="color: #10b981;">-</div>
                        <div class="label">Fixed errors</div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, rgba(245, 158, 11, 0.15) 0%, rgba(245, 158, 11, 0.05) 100%); border: 1px solid rgba(245, 158, 11, 0.2);">
                        <h3>Unresolved</h3>
                        <div class="value" id="unresolvedErrors" style="color: #f59e0b;">-</div>
                        <div class="label">Needs fixing</div>
                    </div>
                </div>
                <div class="table-container">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 style="margin: 0;">Recent Errors (Real-Time)</h3>
                        <div style="display: flex; gap: 12px;">
                            <button 
                                onclick="refreshErrors()" 
                                style="padding: 10px 20px; background: #3b82f6; border: 1px solid #3b82f6; border-radius: 10px; color: #ffffff; font-size: 14px; font-weight: 500; cursor: pointer; font-family: 'Inter', sans-serif; transition: all 0.3s;"
                                onmouseover="this.style.background='#2563eb'"
                                onmouseout="this.style.background='#3b82f6'"
                            >
                                Refresh
                            </button>
                            <button 
                                onclick="exportErrorsCSV()" 
                                style="padding: 10px 20px; background: rgba(255, 255, 255, 0.8); border: 1px solid #e2e8f0; border-radius: 10px; color: #1e293b; font-size: 14px; font-weight: 500; cursor: pointer; font-family: 'Inter', sans-serif; transition: all 0.3s;"
                                onmouseover="this.style.background='rgba(255, 255, 255, 0.95)'"
                                onmouseout="this.style.background='rgba(255, 255, 255, 0.8)'"
                            >
                                Export CSV
                            </button>
                        </div>
                    </div>
                    <div id="errorsList">
                        <div class="loading">Loading...</div>
                    </div>
                </div>
            </div>
            </div>
        </div>
    </div>

    <!-- Email Modal -->
    <div id="emailModal" class="email-modal">
        <div class="email-modal-content">
            <div class="email-modal-header">
                <h2>Send Email to User</h2>
                <button class="email-modal-close" onclick="closeEmailModal()"></button>
            </div>
            <div id="emailModalSuccess" class="email-success"></div>
            <form id="emailModalForm" onsubmit="sendEmail(event)">
                <div class="email-form-group">
                    <label for="emailModalTo">To (Email Address)</label>
                    <input 
                        type="email" 
                        id="emailModalTo" 
                        required
                        placeholder="user@example.com"
                    />
                </div>
                <div class="email-form-group">
                    <label for="emailModalSubject">Subject</label>
                    <input 
                        type="text" 
                        id="emailModalSubject" 
                        required
                        placeholder="Email subject"
                    />
                </div>
                <div class="email-form-group">
                    <label for="emailModalMessage">Message</label>
                    <textarea 
                        id="emailModalMessage" 
                        required
                        placeholder="Enter your message here..."
                    ></textarea>
                </div>
                <div style="display: flex; align-items: center; gap: 12px; padding: 16px; background: rgba(249, 115, 22, 0.1); border: 1px solid rgba(249, 115, 22, 0.3); border-radius: 10px; margin-bottom: 20px;">
                    <input type="checkbox" id="emailModalUseHtml" checked style="width: 20px; height: 20px; cursor: pointer;">
                    <label for="emailUseHtml" style="color: #1e293b; font-size: 14px; font-weight: 500; cursor: pointer; flex: 1;">
                        Use branded HTML template (includes ORA logo and styling)
                    </label>
                </div>
                <div class="email-modal-actions">
                    <button type="button" class="email-modal-btn email-modal-btn-secondary" onclick="closeEmailModal()">
                        Cancel
                    </button>
                    <button type="submit" class="email-modal-btn email-modal-btn-primary">
                        Send Email
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Admin password (in production, use environment variable)
        const ADMIN_PASSWORD = 'ora_admin_2025';
        let currentFilter = 'all';

        // Check if already authenticated
        if (localStorage.getItem('admin_authenticated') === 'true' && localStorage.getItem('admin_token')) {
            showDashboard();
        }

        async function authenticate() {
            const password = document.getElementById('adminPassword').value;
            const errorEl = document.getElementById('authError');
            
            if (password === ADMIN_PASSWORD) {
                // Get admin token from backend
                try {
                    const response = await fetch('/api/admin?type=auth', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ password })
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        localStorage.setItem('admin_authenticated', 'true');
                        localStorage.setItem('admin_token', data.token || ADMIN_PASSWORD);
                        showDashboard();
                        errorEl.style.display = 'none';
                    } else {
                        throw new Error('Authentication failed');
                    }
                } catch (error) {
                    // Fallback: use password as token for local testing
                    localStorage.setItem('admin_authenticated', 'true');
                    localStorage.setItem('admin_token', ADMIN_PASSWORD);
                    showDashboard();
                    errorEl.style.display = 'none';
                }
            } else {
                errorEl.textContent = 'Invalid password';
                errorEl.style.display = 'block';
            }
        }

        function logout() {
            localStorage.removeItem('admin_authenticated');
            localStorage.removeItem('admin_token');
            document.getElementById('authSection').style.display = 'block';
            document.getElementById('dashboard').style.display = 'none';
        }

        function showDashboard() {
            document.getElementById('authSection').style.display = 'none';
            document.getElementById('dashboard').style.display = 'block';
            loadAllData();
        }

        async function loadEmailHistory() {
            try {
                const type = document.getElementById('emailHistoryType')?.value || 'all';
                const status = document.getElementById('emailHistoryStatus')?.value || 'all';
                const search = document.getElementById('emailHistorySearch')?.value || '';
                
                const adminToken = localStorage.getItem('admin_token') || '';
                const params = new URLSearchParams({
                    type,
                    status,
                    limit: '50',
                    offset: '0',
                    ...(search && { search })
                });
                
                // Remove 'type' from params to avoid duplicate parameter
                const cleanParams = new URLSearchParams();
                if (status !== 'all') cleanParams.set('status', status);
                if (search) cleanParams.set('search', search);
                cleanParams.set('limit', '50');
                cleanParams.set('offset', '0');
                
                const queryString = cleanParams.toString();
                const response = await fetch(`/api/admin?type=email-history&token=${adminToken}${queryString ? '&' + queryString : ''}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();

                const emailHistoryEl = document.getElementById('emailHistoryList');
                if (data.success && data.emails && data.emails.length > 0) {
                    emailHistoryEl.innerHTML = `
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="border-bottom: 2px solid #e2e8f0;">
                                    <th style="padding: 12px; text-align: left; color: #1e293b; font-weight: 600; font-size: 14px;">To</th>
                                    <th style="padding: 12px; text-align: left; color: #1e293b; font-weight: 600; font-size: 14px;">Subject</th>
                                    <th style="padding: 12px; text-align: left; color: #1e293b; font-weight: 600; font-size: 14px;">Type</th>
                                    <th style="padding: 12px; text-align: left; color: #1e293b; font-weight: 600; font-size: 14px;">Status</th>
                                    <th style="padding: 12px; text-align: left; color: #1e293b; font-weight: 600; font-size: 14px;">Sent At</th>
                                    <th style="padding: 12px; text-align: left; color: #1e293b; font-weight: 600; font-size: 14px;">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.emails.map(email => {
                                    const statusColor = email.status === 'sent' ? '#10b981' : '#ef4444';
                                    const statusBg = email.status === 'sent' ? 'rgba(16, 185, 129, 0.1)' : 'rgba(239, 68, 68, 0.1)';
                                    const sentDate = new Date(email.sentAt).toLocaleString();
                                    return `
                                        <tr style="border-bottom: 1px solid #e2e8f0; transition: background 0.2s;" onmouseover="this.style.background='rgba(0,0,0,0.02)'" onmouseout="this.style.background='transparent'">
                                            <td style="padding: 12px; color: #1e293b; font-size: 14px;">${email.to}</td>
                                            <td style="padding: 12px; color: #1e293b; font-size: 14px;">${email.subject}</td>
                                            <td style="padding: 12px; color: #64748b; font-size: 13px; text-transform: capitalize;">${email.type}</td>
                                            <td style="padding: 12px;">
                                                <span style="padding: 4px 12px; border-radius: 6px; font-size: 12px; font-weight: 500; background: ${statusBg}; color: ${statusColor};">
                                                    ${email.status}
                                                </span>
                                            </td>
                                            <td style="padding: 12px; color: #64748b; font-size: 13px;">${sentDate}</td>
                                            <td style="padding: 12px;">
                                                <button onclick="viewEmailDetails('${email.id}')" style="padding: 6px 12px; background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.3); border-radius: 6px; color: #3b82f6; font-size: 12px; cursor: pointer; font-family: 'Inter', sans-serif;">
                                                    View
                                                </button>
                                            </td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                        <div style="margin-top: 20px; padding: 16px; background: rgba(255, 255, 255, 0.8); border-radius: 10px; border: 1px solid #e2e8f0; color: #64748b; font-size: 14px;">
                            Showing ${data.emails.length} of ${data.total} emails
                        </div>
                    `;
                } else {
                    emailHistoryEl.innerHTML = `
                        <div style="padding: 40px; text-align: center; color: #64748b;">
                            <p style="font-size: 16px; margin-bottom: 8px;">No emails found</p>
                            <p style="font-size: 14px;">${data.message || 'Start sending emails to see them here'}</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading email history:', error);
                document.getElementById('emailHistoryList').innerHTML = `
                    <div style="padding: 40px; text-align: center; color: #ef4444;">
                        <p>Error loading email history. Please try again.</p>
                    </div>
                `;
            }
        }

        function viewEmailDetails(emailId) {
            // TODO: Implement email detail view modal
            alert('Email details view coming soon!');
        }

        function switchTab(tabName) {
            // Update nav items
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            if (event && event.target) {
                event.target.classList.add('active');
            } else {
                // Find the nav item by tab name
                document.querySelectorAll('.nav-item').forEach(item => {
                    if (item.getAttribute('onclick') && item.getAttribute('onclick').includes(tabName)) {
                        item.classList.add('active');
                    }
                });
            }

            // Update content
            document.querySelectorAll('.content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(tabName).classList.add('active');

            // Load data for the tab
            if (tabName === 'users') {
                loadUsers();
            } else if (tabName === 'subscriptions') {
                loadSubscriptions();
            } else if (tabName === 'deals') {
                loadDeals();
            } else if (tabName === 'quotes') {
                loadQuotes();
            } else if (tabName === 'business') {
                loadBusinessIntelligence();
            } else if (tabName === 'submissions') {
                loadSubmissions();
            } else if (tabName === 'waitlist') {
                loadWaitlist();
            } else if (tabName === 'welcome-emails') {
                loadWelcomeEmailSettings();
            } else if (tabName === 'bulk-email') {
                loadBulkEmailUsers();
            } else if (tabName === 'analytics') {
                loadAnalytics();
            } else if (tabName === 'errors') {
                loadErrors();
            } else if (tabName === 'email-history') {
                loadEmailHistory();
            } else if (tabName === 'send-email') {
                // No data to load, just show the form
            } else if (tabName === 'creator-pool') {
                loadCreatorPool();
            }
        }

        function filterSubmissions(filter) {
            currentFilter = filter;
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            loadSubmissions();
        }

        function openReplyModal(userEmail, submissionId, submissionType, submissionDataStr) {
            const modal = document.getElementById('emailModal');
            const emailTo = document.getElementById('emailTo');
            const emailSubject = document.getElementById('emailSubject');
            const emailMessage = document.getElementById('emailMessage');
            
            // Parse submission data if it's a string
            let submissionData = {};
            try {
                if (typeof submissionDataStr === 'string') {
                    submissionData = JSON.parse(submissionDataStr.replace(/&quot;/g, '"'));
                } else {
                    submissionData = submissionDataStr;
                }
            } catch (e) {
                submissionData = {};
            }
            
            emailTo.value = userEmail || '';
            
            // Create a contextual subject based on submission type
            let subject = '';
            if (submissionType === 'Bug Report') {
                subject = `Re: Your Bug Report - ${submissionData.title || 'Issue'}`;
            } else if (submissionType === 'User Feedback') {
                subject = `Re: Your Feedback - Thank You!`;
            } else if (submissionType === 'Rate Submission') {
                subject = `Re: Your Rate Submission - Thank You!`;
            } else {
                subject = `Re: Your Submission`;
            }
            
            emailSubject.value = subject;
            
            // Pre-fill message with context
            let message = `Hi,\n\n`;
            if (submissionType === 'Bug Report') {
                message += `Thank you for reporting this issue. We've received your bug report about "${submissionData.title || 'the issue'}" and our team is looking into it.\n\n`;
                if (submissionData.description) {
                    message += `Regarding: ${submissionData.description}\n\n`;
                }
            } else if (submissionType === 'User Feedback') {
                message += `Thank you for your feedback! We really appreciate you taking the time to share your thoughts with us.\n\n`;
                if (submissionData.message) {
                    message += `Regarding: ${submissionData.message}\n\n`;
                }
            } else {
                message += `Thank you for your submission! We appreciate your contribution.\n\n`;
            }
            message += `Best regards,\nThe ORA Team`;
            
            emailMessage.value = message;
            modal.classList.add('active');
        }

        // Store data for export
        let allUsersData = [];
        let allDealsData = [];
        let allQuotesData = [];
        let allSubmissionsData = [];
        let allSubscriptionsData = [];
        let allWaitlistData = [];

        async function loadAllData() {
            try {
                // Use Promise.allSettled so one failure doesn't stop all loading
                const results = await Promise.allSettled([
                    loadOverview().catch(err => { console.error('Error loading overview:', err); return null; }),
                    loadUsers().catch(err => { console.error('Error loading users:', err); return null; }),
                    loadSubscriptions().catch(err => { console.error('Error loading subscriptions:', err); return null; }),
                    loadDeals().catch(err => { console.error('Error loading deals:', err); return null; }),
                    loadQuotes().catch(err => { console.error('Error loading quotes:', err); return null; }),
                    loadBusinessIntelligence().catch(err => { console.error('Error loading business:', err); return null; }),
                    loadSubmissions().catch(err => { console.error('Error loading submissions:', err); return null; }),
                    loadWaitlist().catch(err => { console.error('Error loading waitlist:', err); return null; }),
                    loadAnalytics().catch(err => { console.error('Error loading analytics:', err); return null; }),
                    loadErrors().catch(err => { console.error('Error loading errors:', err); return null; }),
                    loadMarketing().catch(err => { console.error('Error loading marketing:', err); return null; }),
                    loadEmailHistory().catch(err => { console.error('Error loading email history:', err); return null; })
                ]);
                
                // Log any failures
                results.forEach((result, index) => {
                    if (result.status === 'rejected') {
                        console.error(`Failed to load data item ${index}:`, result.reason);
                    }
                });
            } catch (error) {
                console.error('Error in loadAllData:', error);
            }
        }

        async function loadUsers() {
            try {
                const adminToken = localStorage.getItem('admin_token') || '';
                const response = await fetch(`/api/admin?type=users&token=${adminToken}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (!data || data.error) {
                    throw new Error(data.error || 'Failed to load users');
                }

                document.getElementById('usersTotalCount').textContent = data.totalUsers || 0;
                document.getElementById('usersActiveCount').textContent = data.activeUsers || 0;
                document.getElementById('usersSubscribedCount').textContent = data.subscribedUsers || 0;
                document.getElementById('usersFreeCount').textContent = (data.totalUsers || 0) - (data.subscribedUsers || 0);

                // Store for export and filtering
                allUsersData = data.users || [];
                renderUsersTable(allUsersData);
            } catch (error) {
                console.error('Error loading users:', error);
                document.getElementById('usersList').innerHTML = '<div class="error">Failed to load users</div>';
            }
        }

        function renderUsersTable(users) {
            const usersEl = document.getElementById('usersList');
            if (users && users.length > 0) {
                usersEl.innerHTML = `
                        <table>
                            <thead>
                                <tr>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Status</th>
                                <th>Signup Date</th>
                                </tr>
                            </thead>
                            <tbody>
                            ${users.map(user => `
                                <tr>
                                    <td>${user.displayName}</td>
                                    <td class="email-clickable" data-email="${user.email}">${user.email}</td>
                                    <td>
                                        ${user.isSubscribed ? '<span class="badge rate">Subscribed</span>' : '<span class="badge" style="background: rgba(0, 0, 0, 0.05); color: #64748b;">Free</span>'}
                                        ${user.isActive ? '<span class="badge" style="background: rgba(16, 185, 129, 0.2); color: #10b981; margin-left: 8px;">Active</span>' : ''}
                                    </td>
                                    <td>${new Date(user.createdAt).toLocaleDateString()}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                
                // Add click handlers to email cells
                document.querySelectorAll('.email-clickable').forEach(cell => {
                    if (cell.textContent !== 'N/A') {
                        cell.style.cursor = 'pointer';
                        cell.style.color = 'rgba(59, 130, 246, 0.9)';
                        cell.style.textDecoration = 'underline';
                        cell.onclick = () => openEmailModal(cell.textContent.trim());
                    }
                });
                } else {
                usersEl.innerHTML = '<div class="empty-state">No users found</div>';
            }
        }

        function filterUsers() {
            const searchTerm = document.getElementById('usersSearch').value.toLowerCase();
            const filtered = allUsersData.filter(user => 
                user.displayName.toLowerCase().includes(searchTerm) ||
                user.email.toLowerCase().includes(searchTerm)
            );
            renderUsersTable(filtered);
        }

        function exportUsersCSV() {
            if (allUsersData.length === 0) {
                alert('No users data to export');
                return;
            }
            
            const headers = ['Name', 'Email', 'Subscribed', 'Active', 'Signup Date'];
            const rows = allUsersData.map(user => [
                user.displayName || '',
                user.email || '',
                user.isSubscribed ? 'Yes' : 'No',
                user.isActive ? 'Yes' : 'No',
                new Date(user.createdAt).toLocaleDateString()
            ]);
            
            const csv = [headers.join(','), ...rows.map(row => row.map(cell => `"${cell}"`).join(','))].join('\n');
            downloadCSV(csv, 'ora_users_' + new Date().toISOString().split('T')[0] + '.csv');
        }

        async function loadDeals() {
            try {
                const adminToken = localStorage.getItem('admin_token') || '';
                const response = await fetch(`/api/admin?type=deals&token=${adminToken}`);
                const data = await response.json();

                document.getElementById('dealsTotalCount').textContent = (data.totalDeals || 0).toLocaleString();
                document.getElementById('dealsTotalRevenue').textContent = `$${(data.totalRevenue || 0).toLocaleString()}`;
                document.getElementById('dealsActiveCount').textContent = (data.statusBreakdown?.active || 0).toLocaleString();
                document.getElementById('dealsCompletedCount').textContent = (data.statusBreakdown?.completed || 0).toLocaleString();
                
                // Add explanation
                if (data.totalDeals === 0) {
                    document.getElementById('dealsList').innerHTML = `
                        <div class="empty-state">
                            <p style="margin-bottom: 12px;">No deals tracked yet.</p>
                            <p style="color: #64748b; font-size: 13px;">Deals are created by users in the Deal Manager to track their projects, collaborations, and payments with brands.</p>
                        </div>
                    `;
                    return;
                }

                // Store for export
                allDealsData = data.allDeals || data.deals || [];

                const dealsEl = document.getElementById('dealsList');
                if (data.deals && data.deals.length > 0) {
                    dealsEl.innerHTML = `
                        <table>
                            <thead>
                                <tr>
                                    <th>Title</th>
                                    <th>Brand</th>
                                    <th>Status</th>
                                    <th>Value</th>
                                    <th>Deadline</th>
                                    <th>Created</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.deals.map(deal => `
                                    <tr>
                                        <td>${deal.title || 'N/A'}</td>
                                        <td>${deal.brandName || 'N/A'}</td>
                                        <td>
                                            <span class="badge" style="background: ${
                                                deal.status === 'active' ? 'rgba(16, 185, 129, 0.2); color: #10b981' :
                                                deal.status === 'completed' ? 'rgba(59, 130, 246, 0.2); color: #3b82f6' :
                                                deal.status === 'pending' ? 'rgba(245, 158, 11, 0.2); color: #f59e0b' :
                                                'rgba(0, 0, 0, 0.05); color: #64748b'
                                            }">
                                                ${deal.status || 'N/A'}
                                            </span>
                                        </td>
                                        <td>${deal.currency || 'USD'} ${(deal.value || 0).toLocaleString()}</td>
                                        <td>${deal.deadline ? new Date(deal.deadline).toLocaleDateString() : 'N/A'}</td>
                                        <td>${new Date(deal.createdAt).toLocaleDateString()}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                } else {
                    dealsEl.innerHTML = '<div class="empty-state">No deals found</div>';
                }
            } catch (error) {
                console.error('Error loading deals:', error);
                document.getElementById('dealsList').innerHTML = '<div class="error">Failed to load deals</div>';
            }
        }

        function exportDealsCSV() {
            if (allDealsData.length === 0) {
                alert('No deals data to export');
                return;
            }
            
            const headers = ['Title', 'Brand', 'Status', 'Value', 'Currency', 'Deadline', 'Created'];
            const rows = allDealsData.map(deal => [
                deal.title || '',
                deal.brand_name || '',
                deal.status || '',
                deal.value || 0,
                deal.currency || 'USD',
                deal.deadline ? new Date(deal.deadline).toLocaleDateString() : '',
                new Date(deal.created_at).toLocaleDateString()
            ]);
            
            const csv = [headers.join(','), ...rows.map(row => row.map(cell => `"${cell}"`).join(','))].join('\n');
            downloadCSV(csv, 'ora_deals_' + new Date().toISOString().split('T')[0] + '.csv');
        }

        async function loadQuotes() {
            try {
                const adminToken = localStorage.getItem('admin_token') || '';
                const response = await fetch(`/api/admin?type=quotes&token=${adminToken}`);
                const data = await response.json();

                document.getElementById('quotesTotalCount').textContent = data.totalQuotes || 0;
                document.getElementById('quotesAcceptedCount').textContent = data.statusBreakdown?.accepted || 0;
                document.getElementById('quotesTotalValue').textContent = `$${(data.totalQuoteValue || 0).toLocaleString()}`;
                document.getElementById('quotesAcceptedValue').textContent = `$${(data.acceptedQuoteValue || 0).toLocaleString()}`;

                // Store for export
                allQuotesData = data.quotes || [];

                const quotesEl = document.getElementById('quotesList');
                if (data.quotes && data.quotes.length > 0) {
                    quotesEl.innerHTML = `
                        <table>
                            <thead>
                                <tr>
                                    <th>Quote Name</th>
                                    <th>Platform</th>
                                    <th>Client</th>
                                    <th>Status</th>
                                    <th>Rate</th>
                                    <th>Followers</th>
                                    <th>Created</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.quotes.map(quote => `
                                    <tr>
                                        <td>${quote.quoteName || 'N/A'}</td>
                                        <td>${quote.platform || 'N/A'}</td>
                                        <td>${quote.clientName || 'N/A'}</td>
                                        <td>
                                            <span class="badge" style="background: ${
                                                quote.status === 'accepted' ? 'rgba(16, 185, 129, 0.2); color: #10b981' :
                                                quote.status === 'sent' ? 'rgba(59, 130, 246, 0.2); color: #3b82f6' :
                                                quote.status === 'rejected' ? 'rgba(255, 59, 48, 0.2); color: #ff3b30' :
                                                quote.status === 'expired' ? 'rgba(0, 0, 0, 0.05); color: #64748b' :
                                                'rgba(245, 158, 11, 0.2); color: #f59e0b'
                                            }">
                                                ${quote.status || 'draft'}
                                            </span>
                                        </td>
                                        <td>$${(quote.calculatedRate || 0).toLocaleString()}</td>
                                        <td>${(quote.followerCount || 0).toLocaleString()}</td>
                                        <td>${new Date(quote.createdAt).toLocaleDateString()}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                } else {
                    quotesEl.innerHTML = '<div class="empty-state">No quotes found</div>';
                }
            } catch (error) {
                console.error('Error loading quotes:', error);
                document.getElementById('quotesList').innerHTML = '<div class="error">Failed to load quotes</div>';
            }
        }

        function exportQuotesCSV() {
            if (allQuotesData.length === 0) {
                alert('No quotes data to export');
                return;
            }
            
            const headers = ['Quote Name', 'Platform', 'Client', 'Status', 'Rate', 'Followers', 'Created'];
            const rows = allQuotesData.map(quote => [
                quote.quoteName || '',
                quote.platform || '',
                quote.clientName || '',
                quote.status || '',
                quote.calculatedRate || 0,
                quote.followerCount || 0,
                new Date(quote.createdAt).toLocaleDateString()
            ]);
            
            const csv = [headers.join(','), ...rows.map(row => row.map(cell => `"${cell}"`).join(','))].join('\n');
            downloadCSV(csv, 'ora_quotes_' + new Date().toISOString().split('T')[0] + '.csv');
        }

        function downloadCSV(csv, filename) {
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        async function loadSubscriptions() {
            try {
                const adminToken = localStorage.getItem('admin_token') || '';
                const response = await fetch(`/api/admin?type=subscriptions&token=${adminToken}`);
                const data = await response.json();

                // Update stats
                document.getElementById('subscriptionsMRR').textContent = `$${(data.revenue?.mrr || 0).toFixed(2)}`;
                document.getElementById('subscriptionsARR').textContent = `$${(data.revenue?.arr || 0).toFixed(2)}`;
                document.getElementById('subscriptionsActive').textContent = data.stats?.active || 0;
                document.getElementById('subscriptionsConversion').textContent = `${((data.stats?.active || 0) / Math.max(data.stats?.total || 1, 1) * 100).toFixed(1)}%`;
                document.getElementById('subscriptionsChurn').textContent = `${(data.churn?.churnRate || 0).toFixed(2)}%`;
                document.getElementById('subscriptionsARPU').textContent = `$${(data.revenue?.averageRevenuePerUser || 0).toFixed(2)}`;

                // Store for export
                allSubscriptionsData = data.subscriptions || [];

                // Render plan breakdown
                const subscriptionsEl = document.getElementById('subscriptionsList');
                if (data.planBreakdown) {
                    subscriptionsEl.innerHTML = `
                        <table>
                            <thead>
                                <tr>
                                    <th>Plan</th>
                                    <th>Subscribers</th>
                                    <th>Status</th>
                                    <th>Monthly Revenue</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${Object.entries(data.planBreakdown).map(([plan, count]) => {
                                    const planPrices = { free: 0, creator: 12.99, pro: 24.99, premium: 49.99 };
                                    const revenue = (planPrices[plan] || 0) * count;
                                    return `
                                        <tr>
                                            <td style="text-transform: capitalize; font-weight: 600;">${plan}</td>
                                            <td>${count}</td>
                                            <td>
                                                <span class="badge" style="background: ${
                                                    plan === 'free' ? 'rgba(0, 0, 0, 0.05); color: #64748b' :
                                                    'rgba(16, 185, 129, 0.2); color: #10b981'
                                                }">
                                                    ${plan === 'free' ? 'Free' : 'Paid'}
                                                </span>
                                            </td>
                                            <td>$${revenue.toFixed(2)}</td>
                                    </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    `;
                } else {
                    subscriptionsEl.innerHTML = '<div class="empty-state">No subscription data found</div>';
                }

                // Render revenue chart
                if (data.monthlyRevenue && data.monthlyRevenue.length > 0) {
                    const chartEl = document.getElementById('revenueChart');
                    const maxRevenue = Math.max(...data.monthlyRevenue.map(m => m.revenue));
                    chartEl.innerHTML = `
                        <div style="display: flex; flex-direction: column; gap: 12px;">
                            ${data.monthlyRevenue.map(month => {
                                const percentage = maxRevenue > 0 ? (month.revenue / maxRevenue) * 100 : 0;
                                return `
                                    <div style="display: flex; align-items: center; gap: 12px;">
                                        <div style="flex: 0 0 100px; font-size: 14px; color: #1e293b;">${month.month}</div>
                                        <div style="flex: 1; height: 32px; background: rgba(0, 0, 0, 0.05); border-radius: 16px; overflow: hidden; position: relative;">
                                            <div style="height: 100%; width: ${percentage}%; background: rgba(249, 115, 22, 0.3); border-radius: 16px; transition: width 0.3s; display: flex; align-items: center; padding: 0 12px;">
                                                <span style="color: #1e293b; font-size: 12px; font-weight: 600;">$${month.revenue.toFixed(2)}</span>
                                            </div>
                                        </div>
                                        <div style="flex: 0 0 80px; text-align: right; font-size: 14px; color: #64748b;">${month.subscribers} users</div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading subscriptions:', error);
                document.getElementById('subscriptionsList').innerHTML = '<div class="error">Failed to load subscriptions</div>';
            }
        }

        function exportSubscriptionsCSV() {
            if (allSubscriptionsData.length === 0) {
                alert('No subscriptions data to export');
                return;
            }
            
            const headers = ['User ID', 'Plan', 'Status', 'Created', 'Period Start', 'Period End'];
            const rows = allSubscriptionsData.map(sub => [
                sub.user_id || '',
                sub.plan || '',
                sub.status || '',
                new Date(sub.created_at).toLocaleDateString(),
                sub.current_period_start ? new Date(sub.current_period_start).toLocaleDateString() : '',
                sub.current_period_end ? new Date(sub.current_period_end).toLocaleDateString() : ''
            ]);
            
            const csv = [headers.join(','), ...rows.map(row => row.map(cell => `"${cell}"`).join(','))].join('\n');
            downloadCSV(csv, 'ora_subscriptions_' + new Date().toISOString().split('T')[0] + '.csv');
        }

        async function loadBusinessIntelligence() {
            try {
                const adminToken = localStorage.getItem('admin_token') || '';
                const response = await fetch(`/api/admin?type=business&token=${adminToken}`);
                const data = await response.json();

                // Update key metrics
                document.getElementById('biTotalRevenue').textContent = `$${(data.revenue?.total || 0).toLocaleString()}`;
                document.getElementById('biTotalUsers').textContent = (data.users?.total || 0).toLocaleString();
                document.getElementById('biActiveUsers').textContent = (data.users?.active || 0).toLocaleString();
                document.getElementById('biARR').textContent = `$${(data.revenue?.arr || 0).toLocaleString()}`;
                document.getElementById('biLTV').textContent = `$${(data.revenue?.lifetimeValue || 0).toFixed(2)}`;
                document.getElementById('biRetention').textContent = `${(data.subscriptions?.retentionRate || 0).toFixed(1)}%`;

                // Revenue breakdown
                const revenueBreakdownEl = document.getElementById('revenueBreakdown');
                revenueBreakdownEl.innerHTML = `
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                        <div style="padding: 20px; background: rgba(255, 255, 255, 0.8); border-radius: 12px; border: 1px solid #e2e8f0;">
                            <div style="font-size: 12px; color: #64748b; margin-bottom: 8px;">Subscriptions</div>
                            <div style="font-size: 24px; font-weight: 600; color: #1e293b;">$${(data.revenue?.fromSubscriptions || 0).toFixed(2)}</div>
                        </div>
                        <div style="padding: 20px; background: rgba(255, 255, 255, 0.8); border-radius: 12px; border: 1px solid #e2e8f0;">
                            <div style="font-size: 12px; color: #64748b; margin-bottom: 8px;">Deals</div>
                            <div style="font-size: 24px; font-weight: 600; color: #1e293b;">$${(data.revenue?.fromDeals || 0).toFixed(2)}</div>
                        </div>
                        <div style="padding: 20px; background: rgba(255, 255, 255, 0.8); border-radius: 12px; border: 1px solid #e2e8f0;">
                            <div style="font-size: 12px; color: #64748b; margin-bottom: 8px;">Quotes</div>
                            <div style="font-size: 24px; font-weight: 600; color: #1e293b;">$${(data.revenue?.fromQuotes || 0).toFixed(2)}</div>
                        </div>
                    </div>
                `;

                // Product metrics
                const productMetricsEl = document.getElementById('productMetrics');
                productMetricsEl.innerHTML = `
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 16px;">
                        <div style="text-align: center; padding: 16px; background: rgba(255, 255, 255, 0.8); border-radius: 10px; border: 1px solid #e2e8f0;">
                            <div style="font-size: 32px; font-weight: 600; color: #1e293b;">${data.product?.quotesGenerated || 0}</div>
                            <div style="font-size: 12px; color: #64748b; margin-top: 4px;">Quotes Generated</div>
                        </div>
                        <div style="text-align: center; padding: 16px; background: rgba(255, 255, 255, 0.8); border-radius: 10px; border: 1px solid #e2e8f0;">
                            <div style="font-size: 32px; font-weight: 600; color: #1e293b;">${data.product?.dealsTracked || 0}</div>
                            <div style="font-size: 12px; color: #64748b; margin-top: 4px;">Deals Tracked</div>
                        </div>
                        <div style="text-align: center; padding: 16px; background: rgba(255, 255, 255, 0.8); border-radius: 10px; border: 1px solid #e2e8f0;">
                            <div style="font-size: 32px; font-weight: 600; color: #1e293b;">${data.product?.contractsAnalyzed || 0}</div>
                            <div style="font-size: 12px; color: #64748b; margin-top: 4px;">Contracts Analyzed</div>
                        </div>
                        <div style="text-align: center; padding: 16px; background: rgba(255, 255, 255, 0.8); border-radius: 10px; border: 1px solid #e2e8f0;">
                            <div style="font-size: 32px; font-weight: 600; color: #1e293b;">${data.product?.mediaKitsCreated || 0}</div>
                            <div style="font-size: 12px; color: #64748b; margin-top: 4px;">Media Kits Created</div>
                        </div>
                    </div>
                `;

                // Growth chart
                if (data.growth?.userGrowth && data.growth.userGrowth.length > 0) {
                    const growthChartEl = document.getElementById('growthChart');
                    const maxUsers = Math.max(...data.growth.userGrowth.map(g => g.users));
                    growthChartEl.innerHTML = `
                        <div style="display: flex; flex-direction: column; gap: 12px;">
                            ${data.growth.userGrowth.map(month => {
                                const percentage = maxUsers > 0 ? (month.users / maxUsers) * 100 : 0;
                                return `
                                    <div style="display: flex; align-items: center; gap: 12px;">
                                        <div style="flex: 0 0 100px; font-size: 14px; color: #1e293b;">${month.month}</div>
                                        <div style="flex: 1; height: 28px; background: rgba(0, 0, 0, 0.05); border-radius: 14px; overflow: hidden; position: relative;">
                                            <div style="height: 100%; width: ${percentage}%; background: rgba(59, 130, 246, 0.3); border-radius: 14px; transition: width 0.3s; display: flex; align-items: center; padding: 0 12px;">
                                                <span style="color: #1e293b; font-size: 12px; font-weight: 600;">${month.users}</span>
                                            </div>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    `;
                }

                // Compliance status
                const complianceEl = document.getElementById('complianceStatus');
                complianceEl.innerHTML = `
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px;">
                        <div style="padding: 16px; background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.2); border-radius: 10px;">
                            <div style="font-size: 14px; color: #10b981; font-weight: 600; margin-bottom: 8px;">GDPR Compliant</div>
                            <div style="font-size: 12px; color: #64748b;">${data.compliance?.dataRetention?.gdprCompliant ? ' Yes' : ' No'}</div>
                        </div>
                        <div style="padding: 16px; background: rgba(255, 255, 255, 0.8); border: 1px solid #e2e8f0; border-radius: 10px;">
                            <div style="font-size: 14px; color: #1e293b; font-weight: 600; margin-bottom: 8px;">Total Records</div>
                            <div style="font-size: 24px; color: #1e293b; font-weight: 600;">${(data.compliance?.dataRetention?.totalRecords || 0).toLocaleString()}</div>
                        </div>
                        <div style="padding: 16px; background: rgba(255, 255, 255, 0.8); border: 1px solid #e2e8f0; border-radius: 10px;">
                            <div style="font-size: 14px; color: #1e293b; font-weight: 600; margin-bottom: 8px;">Data Exports</div>
                            <div style="font-size: 24px; color: #1e293b; font-weight: 600;">${data.compliance?.dataExports || 0}</div>
                        </div>
                        <div style="padding: 16px; background: rgba(255, 255, 255, 0.8); border: 1px solid #e2e8f0; border-radius: 10px;">
                            <div style="font-size: 14px; color: #1e293b; font-weight: 600; margin-bottom: 8px;">Data Deletions</div>
                            <div style="font-size: 24px; color: #1e293b; font-weight: 600;">${data.compliance?.dataDeletions || 0}</div>
                        </div>
                    </div>
                `;
            } catch (error) {
                console.error('Error loading business intelligence:', error);
                document.getElementById('revenueBreakdown').innerHTML = '<div class="error">Failed to load business intelligence data</div>';
            }
        }

        async function loadOverview() {
            try {
                const adminToken = localStorage.getItem('admin_token') || '';
                
                // Load multiple data sources
                const [overviewRes, subscriptionsRes, businessRes] = await Promise.all([
                    fetch(`/api/admin?type=overview&token=${adminToken}`),
                    fetch(`/api/admin?type=subscriptions&token=${adminToken}`),
                    fetch(`/api/admin?type=business&token=${adminToken}`)
                ]);
                
                const overviewData = await overviewRes.json();
                const subscriptionsData = await subscriptionsRes.json();
                const businessData = await businessRes.json();

                // Update submission counts
                document.getElementById('rateSubmissionsCount').textContent = overviewData.rateSubmissions || 0;
                document.getElementById('bugReportsCount').textContent = overviewData.bugReports || 0;
                document.getElementById('userFeedbackCount').textContent = (overviewData.totalSubmissions || 0) - (overviewData.rateSubmissions || 0) - (overviewData.bugReports || 0);
                document.getElementById('activeUsersCount').textContent = overviewData.activeUsers || 0;

                // Update key metrics
                document.getElementById('overviewTotalRevenue').textContent = `$${(businessData.revenue?.total || 0).toLocaleString()}`;
                document.getElementById('overviewTotalUsers').textContent = (businessData.users?.total || 0).toLocaleString();
                document.getElementById('overviewActiveSubs').textContent = (subscriptionsData.stats?.active || 0).toLocaleString();
                document.getElementById('overviewMRR').textContent = `$${(subscriptionsData.revenue?.mrr || 0).toFixed(2)}`;

                // Render recent activity
                const activityEl = document.getElementById('recentActivity');
                if (overviewData.recentActivity && overviewData.recentActivity.length > 0) {
                    activityEl.innerHTML = overviewData.recentActivity.map(item => {
                        const badgeColor = item.type === 'rate_submission' 
                            ? 'rgba(16, 185, 129, 0.2); color: #10b981'
                            : item.type === 'bug_report'
                            ? 'rgba(255, 59, 48, 0.2); color: #ff3b30'
                            : 'rgba(59, 130, 246, 0.2); color: #3b82f6';
                        
                        return `
                            <div style="display: flex; align-items: center; gap: 12px; padding: 12px; background: rgba(255, 255, 255, 0.8); border: 1px solid #e2e8f0; border-radius: 8px; margin-bottom: 8px;">
                                <span class="badge" style="background: ${badgeColor}">${item.type === 'rate_submission' ? 'Rate' : item.type === 'bug_report' ? 'Bug' : 'Feedback'}</span>
                                <span style="flex: 1; color: #1e293b; font-size: 14px;">${item.details || 'N/A'}</span>
                                <span style="color: #64748b; font-size: 12px;">${new Date(item.date).toLocaleDateString()}</span>
                            </div>
                        `;
                    }).join('');
                } else {
                    activityEl.innerHTML = '<div class="empty-state">No recent activity</div>';
                }
            } catch (error) {
                console.error('Error loading overview:', error);
                document.getElementById('recentActivity').innerHTML = '<div class="error">Failed to load overview data</div>';
            }
        }

        async function loadSubmissions() {
            try {
                const adminToken = localStorage.getItem('admin_token') || '';
                const response = await fetch(`/api/admin?type=submissions&filter=${currentFilter}&token=${adminToken}`);
                const data = await response.json();

                // Store for export (get all submissions, not just filtered)
                if (currentFilter === 'all') {
                    allSubmissionsData = data.submissions || [];
                } else {
                    // Load all for export
                    const allResponse = await fetch(`/api/admin?type=submissions&filter=all&token=${adminToken}`);
                    const allData = await allResponse.json();
                    allSubmissionsData = allData.submissions || [];
                }

                const submissionsEl = document.getElementById('submissionsList');
                if (data.submissions && data.submissions.length > 0) {
                    submissionsEl.innerHTML = `
                        <div style="display: flex; flex-direction: column; gap: 16px;">
                            ${data.submissions.map(sub => {
                                const badgeColor = sub.type === 'rate_submission' 
                                    ? 'rgba(16, 185, 129, 0.2); color: #10b981'
                                    : sub.type === 'bug_report'
                                    ? 'rgba(255, 59, 48, 0.2); color: #ff3b30'
                                    : 'rgba(59, 130, 246, 0.2); color: #3b82f6';
                                
                                const typeLabel = sub.type === 'rate_submission' 
                                    ? 'Rate Submission'
                                    : sub.type === 'bug_report'
                                    ? 'Bug Report'
                                    : 'User Feedback';
                                
                                return `
                                    <div style="background: rgba(255, 255, 255, 0.8); border: 1px solid #e2e8f0; border-radius: 12px; padding: 20px; transition: all 0.3s;" 
                                         onmouseover="this.style.background='rgba(255, 255, 255, 0.95)'; this.style.borderColor='#cbd5e1'"
                                         onmouseout="this.style.background='rgba(255, 255, 255, 0.8)'; this.style.borderColor='#e2e8f0'">
                                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 16px;">
                                            <div style="flex: 1;">
                                                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                                                    <span class="badge" style="background: ${badgeColor}">${typeLabel}</span>
                                                    <span style="color: #64748b; font-size: 12px;">${new Date(sub.submittedAt).toLocaleString()}</span>
                                                </div>
                                                ${sub.title ? `<h4 style="color: #1e293b; font-size: 16px; font-weight: 600; margin: 0 0 8px 0;">${sub.title}</h4>` : ''}
                                                ${sub.brandName ? `<p style="color: #334155; margin: 0 0 4px 0;"><strong>Brand:</strong> ${sub.brandName}</p>` : ''}
                                                ${sub.rate ? `<p style="color: #334155; margin: 0 0 4px 0;"><strong>Rate:</strong> $${sub.rate}</p>` : ''}
                                                ${sub.platform ? `<p style="color: #334155; margin: 0 0 4px 0;"><strong>Platform:</strong> ${sub.platform}</p>` : ''}
                                                ${sub.description || sub.message ? `
                                                    <div style="background: rgba(0, 0, 0, 0.03); padding: 12px; border-radius: 8px; margin-top: 12px; border: 1px solid #e2e8f0;">
                                                        <p style="color: #1e293b; margin: 0; line-height: 1.6; white-space: pre-wrap;">${sub.description || sub.message}</p>
                                                    </div>
                                                ` : ''}
                                                ${sub.steps ? `
                                                    <div style="margin-top: 12px;">
                                                        <p style="color: #64748b; font-size: 12px; margin: 0 0 4px 0;"><strong>Steps to reproduce:</strong></p>
                                                        <p style="color: #334155; margin: 0; white-space: pre-wrap;">${sub.steps}</p>
                                                    </div>
                                                ` : ''}
                                            </div>
                                        </div>
                                        <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 16px; padding-top: 16px; border-top: 1px solid #e2e8f0;">
                                            <div style="color: #64748b; font-size: 14px;">
                                                <strong>From:</strong> ${sub.userEmail || 'Anonymous'}
                                            </div>
                                            ${sub.userEmail ? `
                                                <button 
                                                    onclick="openReplyModal('${sub.userEmail.replace(/'/g, "\\'")}', '${sub.id}', '${typeLabel}', ${JSON.stringify(sub).replace(/'/g, "\\'").replace(/"/g, '&quot;')})"
                                                    style="padding: 8px 16px; background: #3b82f6; border: 1px solid #3b82f6; border-radius: 8px; color: #ffffff; font-size: 13px; font-weight: 500; cursor: pointer; font-family: 'Inter', sans-serif; transition: all 0.3s;"
                                                    onmouseover="this.style.background='#2563eb'"
                                                    onmouseout="this.style.background='#3b82f6'"
                                                >
                                                    Reply
                                                </button>
                                            ` : ''}
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    `;
                } else {
                    submissionsEl.innerHTML = '<div class="empty-state">No submissions found</div>';
                }
            } catch (error) {
                console.error('Error loading submissions:', error);
                document.getElementById('submissionsList').innerHTML = '<div class="error">Failed to load submissions</div>';
            }
        }

        function exportSubmissionsCSV() {
            if (allSubmissionsData.length === 0) {
                alert('No submissions data to export');
                return;
            }
            
            const headers = ['Type', 'Details', 'User Email', 'Submitted Date'];
            const rows = allSubmissionsData.map(sub => [
                sub.type || '',
                sub.details || '',
                sub.userEmail || '',
                new Date(sub.submittedAt).toLocaleString()
            ]);
            
            const csv = [headers.join(','), ...rows.map(row => row.map(cell => `"${cell}"`).join(','))].join('\n');
            downloadCSV(csv, 'ora_submissions_' + new Date().toISOString().split('T')[0] + '.csv');
        }

        async function loadWaitlist() {
            try {
                const adminToken = localStorage.getItem('admin_token') || '';
                const response = await fetch(`/api/admin?type=waitlist&token=${adminToken}`);
                const data = await response.json();

                allWaitlistData = data.waitlist || [];

                document.getElementById('waitlistTotalCount').textContent = allWaitlistData.length;

                const now = Date.now();
                const last24h = allWaitlistData.filter(entry => {
                    const created = new Date(entry.createdAt).getTime();
                    return !isNaN(created) && (now - created) <= (24 * 60 * 60 * 1000);
                }).length;
                document.getElementById('waitlist24hCount').textContent = last24h;

                const sourceMap = allWaitlistData.reduce((acc, entry) => {
                    const source = (entry.source || 'unknown').toLowerCase();
                    acc[source] = (acc[source] || 0) + 1;
                    return acc;
                }, {});
                const topSourceEntry = Object.entries(sourceMap).sort((a, b) => b[1] - a[1])[0];
                document.getElementById('waitlistTopSource').textContent = topSourceEntry ? `${topSourceEntry[0]} (${topSourceEntry[1]})` : '-';

                renderWaitlistTable(allWaitlistData);
            } catch (error) {
                console.error('Error loading waitlist:', error);
                document.getElementById('waitlistList').innerHTML = '<div class="error">Failed to load waitlist data</div>';
            }
        }

        function renderWaitlistTable(waitlist) {
            const container = document.getElementById('waitlistList');
            if (!waitlist || waitlist.length === 0) {
                container.innerHTML = '<div class="empty-state">No waitlist signups yet</div>';
                return;
            }

            container.innerHTML = `
                <table>
                    <thead>
                        <tr>
                            <th>Email</th>
                            <th>Source</th>
                            <th>Signed Up</th>
                            <th>Notes</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${waitlist.map(entry => `
                            <tr>
                                <td class="email-clickable" data-email="${entry.email}">${entry.email}</td>
                                <td>${entry.source || 'unknown'}</td>
                                <td>${entry.createdAt ? new Date(entry.createdAt).toLocaleString() : '-'}</td>
                                <td style="max-width: 280px;">
                                    ${entry.metadata?.referer ? `<div><strong>Referrer:</strong> ${entry.metadata.referer}</div>` : ''}
                                    ${entry.metadata?.user_agent ? `<div style="color: rgba(255, 255, 255, 0.7); font-size: 12px;">${entry.metadata.user_agent}</div>` : ''}
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;

            document.querySelectorAll('#waitlistList .email-clickable').forEach(cell => {
                if (cell.textContent !== 'N/A') {
                    cell.style.cursor = 'pointer';
                    cell.style.color = 'rgba(59, 130, 246, 0.9)';
                    cell.style.textDecoration = 'underline';
                    cell.onclick = () => openEmailModal(cell.textContent.trim());
                }
            });
        }

        function exportWaitlistCSV() {
            if (allWaitlistData.length === 0) {
                alert('No waitlist data to export');
                return;
            }

            const headers = ['Email', 'Source', 'Signed Up', 'Referrer', 'User Agent'];
            const rows = allWaitlistData.map(entry => [
                entry.email || '',
                entry.source || '',
                entry.createdAt ? new Date(entry.createdAt).toISOString() : '',
                entry.metadata?.referer || '',
                entry.metadata?.user_agent ? entry.metadata.user_agent.replace(/"/g, '""') : ''
            ]);

            const csv = [headers.join(','), ...rows.map(row => row.map(cell => `"${cell}"`).join(','))].join('\n');
            downloadCSV(csv, 'ora_waitlist_' + new Date().toISOString().split('T')[0] + '.csv');
        }

        async function loadAnalytics() {
            try {
                const adminToken = localStorage.getItem('admin_token') || '';
                const response = await fetch(`/api/admin?type=analytics&token=${adminToken}`);
                const data = await response.json();

                document.getElementById('totalUsers').textContent = data.totalUsers || 0;
                document.getElementById('paidUsers').textContent = data.paidUsers || 0;
                document.getElementById('subscriptionRevenue').textContent = `$${data.subscriptionRevenue?.toFixed(0) || 0}`;
                document.getElementById('conversionRate').textContent = `${data.conversionRate?.toFixed(1) || 0}%`;

                // Platform distribution with visual bars
                const platformEl = document.getElementById('platformDistribution');
                if (data.platformDistribution && Object.keys(data.platformDistribution).length > 0) {
                    const maxCount = Math.max(...Object.values(data.platformDistribution));
                    platformEl.innerHTML = `
                        <div style="display: flex; flex-direction: column; gap: 16px;">
                            ${Object.entries(data.platformDistribution)
                                .sort((a, b) => b[1] - a[1])
                                .map(([platform, count]) => {
                                    const percentage = maxCount > 0 ? (count / maxCount) * 100 : 0;
                                    return `
                                        <div style="display: flex; align-items: center; gap: 12px;">
                                            <div style="flex: 0 0 120px; font-size: 14px; color: rgba(255, 255, 255, 0.8);">${platform}</div>
                                            <div style="flex: 1; height: 24px; background: rgba(0, 0, 0, 0.05); border-radius: 12px; overflow: hidden; position: relative;">
                                                <div style="height: 100%; width: ${percentage}%; background: rgba(255, 255, 255, 0.3); border-radius: 12px; transition: width 0.3s;"></div>
                                            </div>
                                            <div style="flex: 0 0 60px; text-align: right; font-size: 14px; font-weight: 600; color: #ffffff;">${count}</div>
                                        </div>
                                    `;
                                }).join('')}
                        </div>
                    `;
                } else {
                    platformEl.innerHTML = '<div class="empty-state">No platform data available</div>';
                }
            } catch (error) {
                console.error('Error loading analytics:', error);
            }
        }

        // Store errors for export
        let allErrorsData = [];

        async function loadErrors() {
            try {
                const adminToken = localStorage.getItem('admin_token') || '';
                const response = await fetch(`/api/admin?type=errors&token=${adminToken}`);
                const data = await response.json();

                document.getElementById('totalErrors').textContent = (data.totalErrors || 0).toLocaleString();
                document.getElementById('criticalErrors').textContent = (data.criticalErrors || 0).toLocaleString();
                document.getElementById('resolvedErrors').textContent = (data.resolvedErrors || 0).toLocaleString();
                document.getElementById('unresolvedErrors').textContent = (data.unresolvedErrors || 0).toLocaleString();

                // Store for export
                allErrorsData = data.errors || [];

                // Errors list with detailed view
                const errorsEl = document.getElementById('errorsList');
                if (data.errors && data.errors.length > 0) {
                    errorsEl.innerHTML = `
                        <div style="display: flex; flex-direction: column; gap: 16px;">
                            ${data.errors.map(err => {
                                const severityColor = err.severity === 'critical' 
                                    ? 'rgba(255, 59, 48, 0.2); color: #ff3b30'
                                    : err.severity === 'high'
                                    ? 'rgba(255, 107, 107, 0.2); color: #ff6b6b'
                                    : err.severity === 'medium'
                                    ? 'rgba(245, 158, 11, 0.2); color: #f59e0b'
                                    : 'rgba(255, 255, 255, 0.1); color: rgba(255, 255, 255, 0.6)';
                                
                                const typeColor = err.type === 'javascript' 
                                    ? 'rgba(59, 130, 246, 0.2); color: #3b82f6'
                                    : err.type === 'network'
                                    ? 'rgba(139, 92, 246, 0.2); color: #8b5cf6'
                                    : 'rgba(255, 255, 255, 0.1); color: rgba(255, 255, 255, 0.6)';
                                
                                return `
                                    <div style="background: rgba(255, 255, 255, 0.8); border: 1px solid #e2e8f0; border-radius: 12px; padding: 20px; transition: all 0.3s;" 
                                         onmouseover="this.style.background='rgba(255, 255, 255, 0.08)'; this.style.borderColor='rgba(255, 255, 255, 0.2)'"
                                         onmouseout="this.style.background='rgba(255, 255, 255, 0.05)'; this.style.borderColor='rgba(255, 255, 255, 0.1)'">
                                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                                            <div style="flex: 1;">
                                                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                                                    <span class="badge" style="background: ${typeColor}">${err.type || 'unknown'}</span>
                                                    <span class="badge" style="background: ${severityColor}">${err.severity || 'medium'}</span>
                                                    ${err.resolved ? '<span class="badge" style="background: rgba(16, 185, 129, 0.2); color: #10b981">Resolved</span>' : ''}
                                                    <span style="color: rgba(255, 255, 255, 0.6); font-size: 12px;">${new Date(err.timestamp).toLocaleString()}</span>
                                                </div>
                                                <h4 style="color: #ffffff; font-size: 16px; font-weight: 600; margin: 0 0 8px 0;">${err.message || 'Unknown error'}</h4>
                                                ${err.screen ? `<p style="color: rgba(255, 255, 255, 0.7); margin: 0 0 4px 0; font-size: 13px;"><strong>Screen:</strong> ${err.screen}</p>` : ''}
                                                ${err.device ? `<p style="color: rgba(255, 255, 255, 0.7); margin: 0 0 4px 0; font-size: 13px;"><strong>Device:</strong> ${err.device}</p>` : ''}
                                                ${err.appVersion ? `<p style="color: rgba(255, 255, 255, 0.7); margin: 0 0 4px 0; font-size: 13px;"><strong>App Version:</strong> ${err.appVersion}</p>` : ''}
                                                ${err.stack ? `
                                                    <details style="margin-top: 12px;">
                                                        <summary style="color: rgba(255, 255, 255, 0.7); font-size: 13px; cursor: pointer; user-select: none;">View Stack Trace</summary>
                                                        <div style="background: rgba(0, 0, 0, 0.3); padding: 12px; border-radius: 8px; margin-top: 8px; font-family: 'Monaco', 'Courier New', monospace; font-size: 11px; color: rgba(255, 255, 255, 0.8); white-space: pre-wrap; overflow-x: auto;">
${err.stack}
                                                        </div>
                                                    </details>
                                                ` : ''}
                                            </div>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    `;
                } else {
                    errorsEl.innerHTML = '<div class="empty-state">No errors found. Great job!</div>';
                }
            } catch (error) {
                console.error('Error loading errors:', error);
                document.getElementById('errorsList').innerHTML = '<div class="error">Failed to load errors</div>';
            }
        }

        function refreshErrors() {
            loadErrors();
        }

        function exportErrorsCSV() {
            if (allErrorsData.length === 0) {
                alert('No errors data to export');
                return;
            }
            
            const headers = ['Type', 'Severity', 'Message', 'Screen', 'Device', 'App Version', 'Timestamp', 'Resolved'];
            const rows = allErrorsData.map(err => [
                err.type || '',
                err.severity || '',
                err.message || '',
                err.screen || '',
                err.device || '',
                err.appVersion || '',
                new Date(err.timestamp).toLocaleString(),
                err.resolved ? 'Yes' : 'No'
            ]);
            
            const csv = [headers.join(','), ...rows.map(row => row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(','))].join('\n');
            downloadCSV(csv, 'ora_errors_' + new Date().toISOString().split('T')[0] + '.csv');
        }

        function getSeverityColor(severity) {
            const colors = {
                critical: 'rgba(255, 59, 48, 0.2)',
                high: 'rgba(255, 107, 107, 0.2)',
                medium: 'rgba(245, 158, 11, 0.2)',
                low: 'rgba(16, 185, 129, 0.2)'
            };
            return colors[severity] || 'rgba(255, 255, 255, 0.1)';
        }

        // Marketing Functions
        async function loadMarketing() {
            try {
                const adminToken = localStorage.getItem('admin_token') || '';
                const response = await fetch(`/api/admin?type=marketing&token=${adminToken}`);
                const data = await response.json();

                const historyEl = document.getElementById('marketingHistory');
                if (data.notifications && data.notifications.length > 0) {
                    historyEl.innerHTML = data.notifications.map(notif => `
                        <div style="background: rgba(255, 255, 255, 0.8); border: 1px solid #e2e8f0; border-radius: 12px; padding: 20px;">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                                <div style="flex: 1;">
                                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                                        <span class="badge" style="background: rgba(255, 255, 255, 0.2); color: #ffffff;">${notif.type || 'update'}</span>
                                        <span style="color: rgba(255, 255, 255, 0.6); font-size: 12px;">${new Date(notif.sent_at).toLocaleString()}</span>
                                    </div>
                                    <h4 style="color: #ffffff; font-size: 16px; font-weight: 600; margin: 0 0 8px 0;">${notif.title || 'No title'}</h4>
                                    <p style="color: rgba(255, 255, 255, 0.7); margin: 0; font-size: 14px; line-height: 1.6;">${notif.message || ''}</p>
                                    <p style="color: rgba(255, 255, 255, 0.5); margin: 12px 0 0 0; font-size: 12px;">Sent to ${notif.recipient_count || 0} users</p>
                                </div>
                            </div>
                        </div>
                    `).join('');
                } else {
                    historyEl.innerHTML = '<div class="empty-state">No marketing notifications sent yet</div>';
                }
            } catch (error) {
                console.error('Error loading marketing:', error);
                document.getElementById('marketingHistory').innerHTML = '<div class="error">Failed to load marketing history</div>';
            }
        }

        function previewMarketingNotification() {
            const title = document.getElementById('marketingTitle').value;
            const message = document.getElementById('marketingMessage').value;
            const type = document.getElementById('marketingType').value;

            if (!title || !message) {
                alert('Please fill in title and message to preview');
                return;
            }

            const preview = `
Title: ${title}
Type: ${type}
Message: ${message}
            `;
            alert('Preview:\n\n' + preview);
        }

        // Handle marketing form submission
        document.getElementById('marketingForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const title = document.getElementById('marketingTitle').value.trim();
            const message = document.getElementById('marketingMessage').value.trim();
            const type = document.getElementById('marketingType').value;

            if (!title || !message) {
                alert('Please fill in all required fields');
                return;
            }

            if (!confirm(`Send this marketing notification to all users who have opted in?\n\nTitle: ${title}\nMessage: ${message.substring(0, 100)}${message.length > 100 ? '...' : ''}`)) {
                return;
            }

            try {
                const adminToken = localStorage.getItem('admin_token') || '';
                const response = await fetch('/api/admin?type=marketing', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        token: adminToken,
                        title: title,
                        message: message,
                        type: type
                    })
                });

                const data = await response.json();

                if (data.success) {
                    alert(`Marketing notification sent successfully to ${data.recipient_count || 0} users!`);
                    document.getElementById('marketingForm').reset();
                    loadMarketing();
                } else {
                    alert('Failed to send marketing notification: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error sending marketing notification:', error);
                alert('Failed to send marketing notification. Please try again.');
            }
        });

        // Auto-refresh every 30 seconds
        setInterval(() => {
            if (localStorage.getItem('admin_authenticated') === 'true') {
                loadAllData();
            }
        }, 30000);

        // Email Modal Functions
        function openEmailModal(userEmail = '') {
            const modal = document.getElementById('emailModal');
            const emailTo = document.getElementById('emailModalTo') || document.getElementById('emailTo');
            if (emailTo) emailTo.value = userEmail;
            modal.classList.add('active');
        }

        function closeEmailModal() {
            const modal = document.getElementById('emailModal');
            modal.classList.remove('active');
            const form = document.getElementById('emailModalForm') || document.getElementById('emailForm');
            if (form) form.reset();
            const successEl = document.getElementById('emailModalSuccess') || document.getElementById('emailSuccess');
            if (successEl) {
                successEl.classList.remove('show');
                successEl.textContent = '';
            }
        }

        async function sendEmail(event) {
            event.preventDefault();
            
            // Check which form was submitted (modal or tab form)
            const isModal = event.target.id === 'emailModalForm';
            const toEl = isModal ? document.getElementById('emailModalTo') : document.getElementById('emailTo');
            const subjectEl = isModal ? document.getElementById('emailModalSubject') : document.getElementById('emailSubject');
            const messageEl = isModal ? document.getElementById('emailModalMessage') : document.getElementById('emailMessage');
            const useHtmlEl = isModal ? document.getElementById('emailModalUseHtml') : document.getElementById('emailUseHtml');
            const successEl = isModal ? document.getElementById('emailModalSuccess') : document.getElementById('emailSuccess');
            const formEl = isModal ? document.getElementById('emailModalForm') : document.getElementById('emailForm');
            
            const to = toEl?.value.trim() || '';
            const subject = subjectEl?.value.trim() || '';
            const message = messageEl?.value.trim() || '';
            const useHtmlTemplate = useHtmlEl?.checked || false;

            if (!to || !subject || !message) {
                alert('Please fill in all fields');
                return;
            }

            try {
                const adminToken = localStorage.getItem('admin_token') || '';
                const response = await fetch('/api/admin?type=send-email', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        token: adminToken,
                        to: to,
                        subject: subject,
                        message: message,
                        isHtml: false,
                        useHtmlTemplate: useHtmlTemplate
                    })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP error! status: ${response.status}, ${errorText}`);
                }

                const data = await response.json();

                if (data.success) {
                    if (successEl) {
                    successEl.textContent = 'Email sent successfully!';
                    successEl.style.display = 'block';
                    successEl.classList.add('show');
                    }
                    if (formEl) formEl.reset();
                    
                    // Close modal if it was the modal form
                    if (isModal) {
                        setTimeout(() => closeEmailModal(), 2000);
                    }
                    
                    // Reload email history if on that tab
                    if (document.getElementById('email-history')?.classList.contains('active')) {
                        loadEmailHistory();
                    }
                    
                    // Hide success message after 3 seconds
                    if (successEl) {
                    setTimeout(() => {
                        successEl.style.display = 'none';
                        successEl.classList.remove('show');
                    }, 3000);
                    }
                } else {
                    alert('Failed to send email: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error sending email:', error);
                alert('Failed to send email: ' + error.message);
            }
        }

        // Close modal when clicking outside
        document.addEventListener('click', (e) => {
            const modal = document.getElementById('emailModal');
            if (e.target === modal) {
                closeEmailModal();
            }
        });

        // Welcome Email Functions
        async function loadWelcomeEmailSettings() {
            try {
                const adminToken = localStorage.getItem('admin_token') || '';
                const response = await fetch(`/api/admin?type=welcome-email-settings&token=${adminToken}`);
                const data = await response.json();

                if (data.success && data.settings) {
                    document.getElementById('welcomeEmailSubject').value = data.settings.subject || 'Welcome to ORA!';
                    document.getElementById('welcomeEmailMessage').value = data.settings.message || '';
                    document.getElementById('welcomeEmailAutoSend').checked = data.settings.auto_send !== false;
                } else {
                    // If no saved settings, try to restore from localStorage draft
                    restoreWelcomeEmailDraft();
                }
                
                // Set up auto-save listeners
                const subjectInput = document.getElementById('welcomeEmailSubject');
                const messageInput = document.getElementById('welcomeEmailMessage');
                const htmlCheckbox = document.getElementById('welcomeEmailUseHtml');
                const autoSendCheckbox = document.getElementById('welcomeEmailAutoSend');
                
                if (subjectInput) {
                    subjectInput.addEventListener('input', saveWelcomeEmailDraft);
                }
                if (messageInput) {
                    messageInput.addEventListener('input', saveWelcomeEmailDraft);
                }
                if (htmlCheckbox) {
                    htmlCheckbox.addEventListener('change', saveWelcomeEmailDraft);
                }
                if (autoSendCheckbox) {
                    autoSendCheckbox.addEventListener('change', saveWelcomeEmailDraft);
                }
            } catch (error) {
                console.error('Error loading welcome email settings:', error);
                // On error, try to restore from localStorage draft
                restoreWelcomeEmailDraft();
            }
        }

        async function saveWelcomeEmailTemplate() {
            const subjectInput = document.getElementById('welcomeEmailSubject');
            const messageInput = document.getElementById('welcomeEmailMessage');
            const autoSendInput = document.getElementById('welcomeEmailAutoSend');

            if (!subjectInput || !messageInput) {
                alert('Email form fields not found. Please refresh the page.');
                return;
            }

            const subject = subjectInput.value.trim();
            const message = messageInput.value.trim();
            const autoSend = autoSendInput ? autoSendInput.checked : true;

            if (!subject || !message) {
                alert('Please fill in subject and message');
                return;
            }

            try {
                const adminToken = localStorage.getItem('admin_token') || 'ora_admin_2025';
                const response = await fetch('/api/admin?type=welcome-email-settings', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Admin-Token': adminToken
                    },
                    body: JSON.stringify({
                        token: adminToken,
                        subject: subject,
                        message: message,
                        auto_send: autoSend
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();

                if (data.success) {
                    alert('Welcome email template saved successfully!');
                    // Also save to localStorage as backup
                    saveWelcomeEmailDraft();
                } else {
                    alert('Failed to save template: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error saving welcome email template:', error);
                alert('Failed to save template: ' + error.message + '. Please check your connection and try again.');
            }
        }

        // Auto-save welcome email form to localStorage
        function saveWelcomeEmailDraft() {
            try {
                const draft = {
                    subject: document.getElementById('welcomeEmailSubject')?.value || '',
                    message: document.getElementById('welcomeEmailMessage')?.value || '',
                    useHtml: document.getElementById('welcomeEmailUseHtml')?.checked ?? true,
                    autoSend: document.getElementById('welcomeEmailAutoSend')?.checked ?? true,
                    timestamp: Date.now()
                };
                localStorage.setItem('welcomeEmailDraft', JSON.stringify(draft));
            } catch (error) {
                console.error('Error saving welcome email draft:', error);
            }
        }

        // Restore welcome email form from localStorage
        function restoreWelcomeEmailDraft() {
            try {
                const saved = localStorage.getItem('welcomeEmailDraft');
                if (saved) {
                    const draft = JSON.parse(saved);
                    // Only restore if draft is less than 7 days old
                    if (Date.now() - draft.timestamp < 7 * 24 * 60 * 60 * 1000) {
                        if (draft.subject && document.getElementById('welcomeEmailSubject')) {
                            document.getElementById('welcomeEmailSubject').value = draft.subject;
                        }
                        if (draft.message && document.getElementById('welcomeEmailMessage')) {
                            document.getElementById('welcomeEmailMessage').value = draft.message;
                        }
                        if (document.getElementById('welcomeEmailUseHtml')) {
                            document.getElementById('welcomeEmailUseHtml').checked = draft.useHtml !== false;
                        }
                        if (document.getElementById('welcomeEmailAutoSend')) {
                            document.getElementById('welcomeEmailAutoSend').checked = draft.autoSend !== false;
                        }
                    }
                }
            } catch (error) {
                console.error('Error restoring welcome email draft:', error);
            }
        }

        function previewWelcomeEmail() {
            const subject = document.getElementById('welcomeEmailSubject').value;
            const message = document.getElementById('welcomeEmailMessage').value;
            
            if (!subject || !message) {
                alert('Please fill in subject and message to preview');
                return;
            }
            
            // Generate HTML preview using inline template function (same as email-template.js)
            const personalizedMessage = message.replace(/\{\{displayName\}\}/g, 'John Doe');
            const lines = personalizedMessage.split('\n');
            let htmlMessage = '';
            let inBulletList = false;
            
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];
                const trimmedLine = line.trim();
                
                if (trimmedLine === '') {
                    if (inBulletList) {
                        htmlMessage += '</ul>';
                        inBulletList = false;
                    }
                    htmlMessage += '<br>';
                } else if (trimmedLine.startsWith('')) {
                    if (!inBulletList) {
                        htmlMessage += '<ul style="margin: 12px 0; padding-left: 24px; list-style-type: disc;">';
                        inBulletList = true;
                    }
                    const bulletText = trimmedLine.substring(1).trim();
                    const formattedText = bulletText.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                    htmlMessage += `<li style="margin-bottom: 8px; line-height: 1.6;">${formattedText}</li>`;
                } else {
                    if (inBulletList) {
                        htmlMessage += '</ul>';
                        inBulletList = false;
                    }
                    let processedLine = trimmedLine.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                    htmlMessage += `<p style="margin: 0 0 12px 0; line-height: 1.6;">${processedLine}</p>`;
                }
            }
            
            if (inBulletList) {
                htmlMessage += '</ul>';
            }
            
            // Generate full email HTML
            const emailHtml = generateWelcomeEmailHTML(subject, htmlMessage);
            
            // Open preview in new window
            const previewWindow = window.open('', '_blank', 'width=800,height=600');
            previewWindow.document.write(emailHtml);
            previewWindow.document.close();
        }
        
        function generateWelcomeEmailHTML(subject, htmlMessage) {
            return `<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${subject}</title>
</head>
<body style="margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; background-color: #f5f5f7;">
    <table width="100%" cellpadding="0" cellspacing="0" style="background-color: #f5f5f7; padding: 40px 20px;">
        <tr>
            <td align="center">
                <table width="600" cellpadding="0" cellspacing="0" style="background-color: #ffffff; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                    <tr>
                        <td style="background: linear-gradient(180deg, #f97316 0%, #ea580c 30%, #ffffff 100%); padding: 40px; text-align: center;">
                            <div style="width: 80px; height: 80px; margin: 0 auto 20px; padding: 12px; background: rgba(255, 255, 255, 0.2); border-radius: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); display: flex; align-items: center; justify-content: center;">
                                <img src="https://myora.co/adaptive-icon.png" alt="ORA Logo" style="width: 100%; height: 100%; object-fit: contain; transform: scale(2.2);" />
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <td style="padding: 45px 40px;">
                            ${htmlMessage}
                        </td>
                    </tr>
                    <tr>
                        <td style="background: #F5F5F7; padding: 30px; text-align: center; border-top: 1px solid #E5E5E7;">
                            <p style="color: #8E8E93; font-size: 12px; margin: 0;"> 2025 ORA. All rights reserved.</p>
                        </td>
                    </tr>
                </table>
            </td>
        </tr>
    </table>
</body>
</html>`;
        }

        async function sendWelcomeEmailToUser() {
            const to = document.getElementById('welcomeEmailTo').value.trim();
            const subject = document.getElementById('welcomeEmailSubject').value.trim();
            const message = document.getElementById('welcomeEmailMessage').value.trim();

            if (!to || !subject || !message) {
                alert('Please fill in all fields');
                return;
            }

            // Get user's display name from Supabase if possible
            let displayName = 'Creator';
            try {
                const adminToken = localStorage.getItem('admin_token') || '';
                const usersResponse = await fetch(`/api/admin?type=users&token=${adminToken}`);
                const usersData = await usersResponse.json();
                if (usersData.users) {
                    const user = usersData.users.find(u => u.email === to);
                    if (user && user.displayName) {
                        displayName = user.displayName;
                    }
                }
            } catch (e) {
                console.log('Could not fetch user name, using default');
            }

            // Replace {{displayName}} with actual name
            const personalizedMessage = message.replace(/\{\{displayName\}\}/g, displayName);

            try {
                const adminToken = localStorage.getItem('admin_token') || '';
                const response = await fetch('/api/admin?type=send-email', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        token: adminToken,
                        to: to,
                        subject: subject,
                        message: personalizedMessage,
                        isHtml: false,
                        useHtmlTemplate: document.getElementById('welcomeEmailUseHtml').checked
                    })
                });

                const data = await response.json();

                if (data.success) {
                    alert('Welcome email sent successfully!');
                    document.getElementById('welcomeEmailTo').value = '';
                } else {
                    alert('Failed to send welcome email: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error sending welcome email:', error);
                alert('Failed to send welcome email. Please try again.');
            }
        }

        // Bulk Email Functions
        let allBulkEmailUsers = [];

        async function loadBulkEmailUsers() {
            try {
                const adminToken = localStorage.getItem('admin_token') || '';
                const response = await fetch(`/api/admin?type=users&token=${adminToken}`);
                const data = await response.json();

                if (data.users) {
                    allBulkEmailUsers = data.users;
                    
                    // Update counts
                    const allCount = data.users.length;
                    const subscribedCount = data.users.filter(u => u.isSubscribed).length;
                    const freeCount = data.users.filter(u => !u.isSubscribed).length;
                    
                    document.getElementById('allUsersCount').textContent = allCount;
                    document.getElementById('subscribedUsersCount').textContent = subscribedCount;
                    document.getElementById('freeUsersCount').textContent = freeCount;
                    
                    // Load creator pool count
                    try {
                        const saved = localStorage.getItem('creatorPool');
                        const poolData = saved ? JSON.parse(saved) : [];
                        const creatorPoolCountEl = document.getElementById('creatorPoolRecipientsCount');
                        if (creatorPoolCountEl) {
                            creatorPoolCountEl.textContent = poolData.length;
                        }
                    } catch (error) {
                        console.error('Error loading creator pool count:', error);
                    }

                    // Load user list for custom selection
                    const userListEl = document.getElementById('bulkEmailUserList');
                    userListEl.innerHTML = data.users.map(user => `
                        <label style="display: flex; align-items: center; gap: 12px; padding: 8px; cursor: pointer; border-radius: 6px; transition: background 0.2s;" 
                               onmouseover="this.style.background='rgba(0,0,0,0.03)'" 
                               onmouseout="this.style.background='transparent'">
                            <input type="checkbox" class="bulk-email-user-checkbox" value="${user.email}" data-name="${user.displayName || user.email}" style="width: 18px; height: 18px; cursor: pointer;">
                            <span style="color: #1e293b; font-size: 14px; flex: 1;">${user.displayName || 'No name'} (${user.email})</span>
                            ${user.isSubscribed ? '<span style="color: #10b981; font-size: 12px;">Subscribed</span>' : ''}
                        </label>
                    `).join('');
                }
            } catch (error) {
                console.error('Error loading users for bulk email:', error);
            }
        }

        // Handle recipient type change
        document.addEventListener('change', (e) => {
            if (e.target.name === 'bulkEmailRecipients') {
                const customSection = document.getElementById('customRecipientsSection');
                const manualSection = document.getElementById('manualRecipientsSection');
                const creatorPoolSection = document.getElementById('creatorPoolRecipientsSection');
                
                if (e.target.value === 'custom') {
                    customSection.style.display = 'block';
                    manualSection.style.display = 'none';
                    creatorPoolSection.style.display = 'none';
                } else if (e.target.value === 'manual') {
                    customSection.style.display = 'none';
                    manualSection.style.display = 'block';
                    creatorPoolSection.style.display = 'none';
                } else if (e.target.value === 'creator-pool') {
                    customSection.style.display = 'none';
                    manualSection.style.display = 'none';
                    creatorPoolSection.style.display = 'block';
                    loadCreatorPoolRecipients();
                } else {
                    customSection.style.display = 'none';
                    manualSection.style.display = 'none';
                    creatorPoolSection.style.display = 'none';
                }
            }
        });

        // Load creator pool recipients for bulk email
        function loadCreatorPoolRecipients() {
            try {
                const saved = localStorage.getItem('creatorPool');
                const poolData = saved ? JSON.parse(saved) : [];
                // Only show creators that are selected for email
                const selectedCreators = poolData.filter(c => c.selectedForEmail !== false);
                const listEl = document.getElementById('creatorPoolRecipientsList');
                const countEl = document.getElementById('creatorPoolRecipientsCount');
                
                if (countEl) countEl.textContent = selectedCreators.length;

                if (poolData.length === 0) {
                    listEl.innerHTML = '<div style="text-align: center; padding: 20px; color: #64748b; font-size: 14px;">Your Creator Pool is empty. Go to the Creator Pool tab to add creators.</div>';
                    return;
                }

                if (selectedCreators.length === 0) {
                    listEl.innerHTML = '<div style="text-align: center; padding: 20px; color: #f59e0b; font-size: 14px;">No creators selected for email. Go to the Creator Pool tab and check the creators you want to email.</div>';
                    return;
                }

                listEl.innerHTML = `
                    <div style="display: flex; flex-direction: column; gap: 8px;">
                        ${selectedCreators.map(creator => {
                            const socialMedia = [];
                            if (creator.instagram) socialMedia.push(` ${creator.instagram}`);
                            if (creator.tiktok) socialMedia.push(` ${creator.tiktok}`);
                            if (creator.youtube) socialMedia.push(` ${creator.youtube}`);
                            if (creator.twitter) socialMedia.push(` ${creator.twitter}`);
                            
                            return `
                                <div style="padding: 12px; background: rgba(249, 115, 22, 0.05); border: 1px solid rgba(249, 115, 22, 0.2); border-radius: 8px;">
                                    <div style="font-weight: 600; color: #1e293b; font-size: 14px; margin-bottom: 4px;">${escapeHtml(creator.name)}</div>
                                    <div style="color: #3b82f6; font-size: 13px; margin-bottom: 4px;">${escapeHtml(creator.email)}</div>
                                    ${socialMedia.length > 0 ? `<div style="color: #64748b; font-size: 12px; margin-top: 4px;">${socialMedia.join('  ')}</div>` : ''}
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
            } catch (error) {
                console.error('Error loading creator pool recipients:', error);
                document.getElementById('creatorPoolRecipientsList').innerHTML = '<div style="text-align: center; padding: 20px; color: #ef4444; font-size: 14px;">Error loading creator pool. Please try again.</div>';
            }
        }

        // Toggle all creator pool recipients
        function toggleAllCreatorPoolRecipients() {
            const checkboxes = document.querySelectorAll('.creator-pool-recipient-checkbox');
            if (checkboxes.length === 0) return;
            
            const allChecked = Array.from(checkboxes).every(cb => cb.checked);
            checkboxes.forEach(cb => {
                cb.checked = !allChecked;
            });
            
            const button = event.target;
            button.textContent = allChecked ? 'Select All' : 'Deselect All';
        }

        // Live Email Preview Function
        function updateEmailPreview() {
            const subject = document.getElementById('bulkEmailSubject')?.value || '';
            const message = document.getElementById('bulkEmailMessage')?.value || '';
            const useHtml = document.getElementById('bulkEmailUseHtml')?.checked ?? true;
            const appStoreUrl = document.getElementById('appStoreUrl')?.value || null;
            const previewDiv = document.getElementById('emailLivePreview');
            
            if (!previewDiv) return;
            
            if (!message.trim()) {
                previewDiv.innerHTML = '<div style="padding: 40px; text-align: center; color: #94a3b8;"><p>Start typing to see preview...</p></div>';
                return;
            }
            
            if (useHtml) {
                // Generate HTML preview using the same template logic
                const personalizedMessage = message.replace(/\{\{displayName\}\}/g, 'John Doe');
                const primaryColor = '#f97316';
                const backgroundColor = '#ffffff';
                const textColor = '#1e293b';
                const logoUrl = 'https://myora.co/adaptive-icon.png';
                
                // Convert message to HTML with proper bullet point handling
                const lines = personalizedMessage.split('\n');
                let htmlMessage = '';
                let inBulletList = false;
                
                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i];
                    const trimmedLine = line.trim();
                    
                    if (trimmedLine === '') {
                        if (inBulletList) {
                            htmlMessage += '</ul>';
                            inBulletList = false;
                        }
                        htmlMessage += '<br>';
                    } else if (trimmedLine.startsWith('')) {
                        if (!inBulletList) {
                            htmlMessage += '<ul style="margin: 12px 0; padding-left: 24px; list-style-type: disc;">';
                            inBulletList = true;
                        }
                        const bulletText = trimmedLine.substring(1).trim();
                        const formattedText = bulletText.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                        htmlMessage += `<li style="margin-bottom: 8px; line-height: 1.6;">${formattedText}</li>`;
                    } else {
                        if (inBulletList) {
                            htmlMessage += '</ul>';
                            inBulletList = false;
                        }
                        // Handle bold text first
                        let processedLine = trimmedLine.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                        
                        if (trimmedLine.includes('[App Store]') || trimmedLine.includes('[Download on App Store]')) {
                            // Skip this line, will add badge at end
                            htmlMessage += '';
                        } else {
                            htmlMessage += `<p style="margin: 0 0 12px 0; line-height: 1.6;">${processedLine}</p>`;
                        }
                    }
                }
                
                if (inBulletList) {
                    htmlMessage += '</ul>';
                }
                
                // Add App Store badge at the end if found
                const hasAppStore = personalizedMessage.includes('[App Store]') || personalizedMessage.includes('[Download on App Store]');
                if (hasAppStore) {
                    const url = appStoreUrl || 'https://apps.apple.com/us/app/my-ora/id6755090210';
                    const appIdMatch = url.match(/\/id(\d+)/);
                    const appId = appIdMatch ? appIdMatch[1] : null;
                    
                    // Use styled button with Apple logo (matches actual email template)
                    htmlMessage += `<p style="margin: 30px 0 20px 0; text-align: center;">
                        <table cellpadding="0" cellspacing="0" style="margin: 0 auto; border-collapse: separate; border-spacing: 0;">
                            <tr>
                                <td style="background: #333333; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.2); border: none;">
                                    <a href="${url}" target="_blank" rel="noopener noreferrer" style="display: block; text-decoration: none !important; padding: 10px 20px; color: #ffffff; border: none; outline: none;">
                                        <table cellpadding="0" cellspacing="0" width="100%" style="border: none;">
                                            <tr>
                                                <td style="text-align: center; padding: 0; border: none;">
                                                    <!-- Download arrow pointing down -->
                                                    <div style="font-size: 20px; color: #ffffff; font-weight: bold; line-height: 1; margin-bottom: 2px;"></div>
                                                    <div style="color: #ffffff; font-size: 14px; font-weight: 600; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; letter-spacing: 0.3px; line-height: 1.3; text-decoration: none !important;">
                                                        Download on the<br>App Store
                                                    </div>
                                                </td>
                                            </tr>
                                        </table>
                                    </a>
                                </td>
                            </tr>
                        </table>
                    </p>`;
                }
                
                const emailHtml = `
                    <div style="max-width: 600px; margin: 0 auto; background: #f5f5f7; padding: 20px;">
                        <div style="background: ${backgroundColor}; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                            <!-- Header with Logo -->
                            <div style="background: linear-gradient(180deg, ${primaryColor} 0%, #ea580c 30%, #ffffff 100%); padding: 50px 40px 40px 40px; text-align: center;">
                                <div style="display: inline-block; width: 90px; height: 90px; background-color: #ffffff; border-radius: 18px; padding: 6px; margin-bottom: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); overflow: hidden; position: relative;">
                                    <img src="${logoUrl}" alt="ORA" style="width: 100%; height: 100%; object-fit: contain; object-position: center; border-radius: 12px; transform: scale(2.2);" onerror="this.style.display='none'; this.parentElement.innerHTML='<div style=\\'font-size: 36px; color: ${primaryColor};\\'>ORA</div>';" />
                                </div>
                            </div>
                            <!-- Content -->
                            <div style="padding: 45px 40px; color: ${textColor}; font-size: 16px; line-height: 1.6;">
                                ${htmlMessage}
                            </div>
                            <!-- Footer -->
                            <div style="background: #f8fafc; padding: 30px 40px; text-align: center; border-top: 1px solid #e2e8f0;">
                                <p style="color: #64748b; font-size: 12px; margin: 0 0 10px 0;">
                                    <a href="https://myora.co" style="color: ${primaryColor}; text-decoration: none; font-weight: 500;">Visit ORA</a> | 
                                    <a href="https://myora.co/privacy-policy" style="color: #64748b; text-decoration: none;">Privacy Policy</a>
                                </p>
                                <p style="color: #94a3b8; font-size: 11px; margin: 10px 0 0 0;"> 2025 ORA. All rights reserved.</p>
                            </div>
                        </div>
                    </div>
                `;
                previewDiv.innerHTML = emailHtml;
            } else {
                // Plain text preview
            const preview = message.replace(/\{\{displayName\}\}/g, 'John Doe');
                previewDiv.innerHTML = `<div style="padding: 20px; white-space: pre-wrap; font-family: monospace; color: #1e293b; background: #ffffff; border-radius: 8px;">${preview}</div>`;
            }
        }
        
        // Auto-save bulk email form to localStorage
        function saveBulkEmailDraft() {
            try {
                const draft = {
                    subject: document.getElementById('bulkEmailSubject')?.value || '',
                    message: document.getElementById('bulkEmailMessage')?.value || '',
                    useHtml: document.getElementById('bulkEmailUseHtml')?.checked ?? true,
                    appStoreUrl: document.getElementById('appStoreUrl')?.value || '',
                    recipientType: document.querySelector('input[name="bulkEmailRecipients"]:checked')?.value || 'all',
                    timestamp: Date.now()
                };
                localStorage.setItem('bulkEmailDraft', JSON.stringify(draft));
            } catch (error) {
                console.error('Error saving bulk email draft:', error);
            }
        }

        // Restore bulk email form from localStorage
        function restoreBulkEmailDraft() {
            try {
                const saved = localStorage.getItem('bulkEmailDraft');
                if (saved) {
                    const draft = JSON.parse(saved);
                    // Only restore if draft is less than 7 days old
                    if (Date.now() - draft.timestamp < 7 * 24 * 60 * 60 * 1000) {
                        if (draft.subject && document.getElementById('bulkEmailSubject')) {
                            document.getElementById('bulkEmailSubject').value = draft.subject;
                        }
                        if (draft.message && document.getElementById('bulkEmailMessage')) {
                            document.getElementById('bulkEmailMessage').value = draft.message;
                        }
                        if (document.getElementById('bulkEmailUseHtml')) {
                            document.getElementById('bulkEmailUseHtml').checked = draft.useHtml !== false;
                        }
                        if (draft.appStoreUrl && document.getElementById('appStoreUrl')) {
                            document.getElementById('appStoreUrl').value = draft.appStoreUrl;
                        }
                        if (draft.recipientType) {
                            const radio = document.querySelector(`input[name="bulkEmailRecipients"][value="${draft.recipientType}"]`);
                            if (radio) radio.checked = true;
                        }
                    }
                }
            } catch (error) {
                console.error('Error restoring bulk email draft:', error);
            }
        }

        // Clear draft after successful send
        function clearBulkEmailDraft() {
            localStorage.removeItem('bulkEmailDraft');
        }

        // Set up live preview listeners and auto-save
        document.addEventListener('DOMContentLoaded', function() {
            const subjectInput = document.getElementById('bulkEmailSubject');
            const messageInput = document.getElementById('bulkEmailMessage');
            const htmlCheckbox = document.getElementById('bulkEmailUseHtml');
            const appStoreInput = document.getElementById('appStoreUrl');
            
            // Restore saved draft first
            restoreBulkEmailDraft();
            
            // Set up auto-save on input
            if (subjectInput) {
                subjectInput.addEventListener('input', () => {
                    updateEmailPreview();
                    saveBulkEmailDraft();
                });
            }
            if (messageInput) {
                messageInput.addEventListener('input', () => {
                    updateEmailPreview();
                    saveBulkEmailDraft();
                });
            }
            if (htmlCheckbox) {
                htmlCheckbox.addEventListener('change', () => {
                    updateEmailPreview();
                    saveBulkEmailDraft();
                });
            }
            if (appStoreInput) {
                appStoreInput.addEventListener('input', () => {
                    updateEmailPreview();
                    saveBulkEmailDraft();
                });
            }
            
            // Auto-save on recipient type change
            const recipientRadios = document.querySelectorAll('input[name="bulkEmailRecipients"]');
            recipientRadios.forEach(radio => {
                radio.addEventListener('change', saveBulkEmailDraft);
            });
            
            // Initial preview update
            setTimeout(updateEmailPreview, 500);
        });
        
        function previewBulkEmail() {
            updateEmailPreview();
            alert('Preview updated! Check the Live Preview panel on the right.');
        }

        async function sendBulkEmail() {
            const subject = document.getElementById('bulkEmailSubject').value.trim();
            const message = document.getElementById('bulkEmailMessage').value.trim();
            const recipientType = document.querySelector('input[name="bulkEmailRecipients"]:checked').value;

            if (!subject || !message) {
                alert('Please fill in subject and message');
                return;
            }

            // Get recipient list based on selection
            let recipients = [];
            if (recipientType === 'all') {
                recipients = allBulkEmailUsers.map(u => ({ email: u.email, displayName: u.displayName || u.email.split('@')[0] }));
            } else if (recipientType === 'subscribed') {
                recipients = allBulkEmailUsers
                    .filter(u => u.isSubscribed)
                    .map(u => ({ email: u.email, displayName: u.displayName || u.email.split('@')[0] }));
            } else if (recipientType === 'free') {
                recipients = allBulkEmailUsers
                    .filter(u => !u.isSubscribed)
                    .map(u => ({ email: u.email, displayName: u.displayName || u.email.split('@')[0] }));
            } else if (recipientType === 'custom') {
                const checked = document.querySelectorAll('.bulk-email-user-checkbox:checked');
                recipients = Array.from(checked).map(cb => ({
                    email: cb.value,
                    displayName: cb.dataset.name || cb.value.split('@')[0]
                }));
            } else if (recipientType === 'creator-pool') {
                // Get selected creators from localStorage
                try {
                    const saved = localStorage.getItem('creatorPool');
                    const poolData = saved ? JSON.parse(saved) : [];
                    const selectedCreators = poolData.filter(c => c.selectedForEmail !== false);
                    
                    if (selectedCreators.length === 0) {
                        alert('No creators selected for email. Go to the Creator Pool tab and check the creators you want to email.');
                        return;
                    }
                    
                    recipients = selectedCreators.map(creator => ({
                        email: creator.email,
                        displayName: creator.name || creator.email.split('@')[0]
                    }));
                } catch (error) {
                    console.error('Error loading creator pool:', error);
                    alert('Error loading creator pool. Please try again.');
                    return;
                }
            } else if (recipientType === 'manual') {
                const emailInputs = document.querySelectorAll('.bulk-email-manual-input');
                const emailList = Array.from(emailInputs)
                    .map(input => input.value.trim())
                    .filter(email => email.length > 0);
                
                if (emailList.length === 0) {
                    alert('Please add at least one email address');
                    return;
                }
                
                // Validate email format
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                const validEmails = emailList.filter(email => emailRegex.test(email));
                const invalidEmails = emailList.filter(email => !emailRegex.test(email));
                
                if (invalidEmails.length > 0) {
                    if (!confirm(`${invalidEmails.length} invalid email address(es) found:\n${invalidEmails.join(', ')}\n\nContinue with only valid emails?`)) {
                        return;
                    }
                }
                
                if (validEmails.length === 0) {
                    alert('No valid email addresses found');
                    return;
                }
                
                recipients = validEmails.map(email => ({
                    email: email,
                    displayName: email.split('@')[0]
                }));
            }

            if (recipients.length === 0) {
                alert('No recipients selected');
                return;
            }

            if (!confirm(`Send this email to ${recipients.length} users? Each email will be sent individually so recipients won't see each other's addresses.`)) {
                return;
            }

            // Show progress
            const sendBtn = event.target;
            const originalText = sendBtn.textContent;
            sendBtn.disabled = true;
            sendBtn.textContent = `Sending... (0/${recipients.length})`;

            let successCount = 0;
            let failCount = 0;

            // Send emails individually in batches to avoid rate limiting
            const batchSize = 5;
            for (let i = 0; i < recipients.length; i += batchSize) {
                const batch = recipients.slice(i, i + batchSize);
                
                await Promise.all(batch.map(async (recipient) => {
                    try {
                        const adminToken = localStorage.getItem('admin_token') || '';
                        const personalizedMessage = message.replace(/\{\{displayName\}\}/g, recipient.displayName);
                        
                        const response = await fetch('/api/admin?type=send-email', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                token: adminToken,
                                to: recipient.email,
                                subject: subject,
                                message: personalizedMessage,
                                isHtml: false,
                                useHtmlTemplate: document.getElementById('bulkEmailUseHtml')?.checked ?? true,
                                useHelloEmail: true, // Use hello email for bulk emails
                                appStoreUrl: document.getElementById('appStoreUrl')?.value || null // App Store URL if set
                            })
                        });

                        const data = await response.json();
                        if (data.success) {
                            successCount++;
                        } else {
                            failCount++;
                            console.error(`Failed to send to ${recipient.email}:`, data.error);
                        }
                    } catch (error) {
                        failCount++;
                        console.error(`Error sending to ${recipient.email}:`, error);
                    }
                }));

                // Update progress
                sendBtn.textContent = `Sending... (${Math.min(i + batchSize, recipients.length)}/${recipients.length})`;
                
                // Small delay between batches to avoid overwhelming the server
                if (i + batchSize < recipients.length) {
                    await new Promise(resolve => setTimeout(resolve, 1000));
                }
            }

            sendBtn.disabled = false;
            sendBtn.textContent = originalText;

            if (successCount > 0) {
                // Clear draft after successful send
                clearBulkEmailDraft();
            }

                alert(`Bulk email completed!\n\nSuccessfully sent: ${successCount}\nFailed: ${failCount}\n\nEach email was sent individually, so recipients cannot see each other's addresses.`);
        }

        function addEmailInput() {
            const container = document.getElementById('bulkEmailManualInputs');
            const newInput = document.createElement('div');
            newInput.style.cssText = 'display: flex; gap: 8px; align-items: center;';
            newInput.innerHTML = `
                <input type="email" class="bulk-email-manual-input" placeholder="email@example.com"
                    style="flex: 1; padding: 10px 14px; border: 1px solid #e2e8f0; border-radius: 8px; background: #ffffff; color: #1e293b; font-size: 14px; font-family: 'Inter', sans-serif;">
                <button type="button" onclick="removeEmailInput(this)" 
                    style="padding: 10px 14px; background: #ef4444; border: 1px solid #ef4444; border-radius: 8px; color: #ffffff; font-size: 13px; font-weight: 500; cursor: pointer; font-family: 'Inter', sans-serif; transition: all 0.3s;"
                    onmouseover="this.style.background='#dc2626'"
                    onmouseout="this.style.background='#ef4444'">Remove</button>
            `;
            container.appendChild(newInput);
            
            // Focus on the new input
            const input = newInput.querySelector('input');
            input.focus();
        }

        function removeEmailInput(button) {
            const container = document.getElementById('bulkEmailManualInputs');
            const inputs = container.querySelectorAll('.bulk-email-manual-input');
            
            // Don't allow removing if it's the last one
            if (inputs.length <= 1) {
                alert('You need at least one email input. Clear it instead of removing.');
                return;
            }
            
            button.parentElement.remove();
        }

        // Load App Store Launch Email Template
        async function loadAppStoreLaunchEmail() {
            try {
                // Load the template from the server
                const response = await fetch('/lib/admin/app-store-launch-email.js');
                const text = await response.text();
                
                // Extract the email content (simple parsing)
                const subjectMatch = text.match(/subject:\s*["']([^"']+)["']/i);
                const messageMatch = text.match(/message:\s*`([^`]+)`/s);
                const urlMatch = text.match(/appStoreUrl:\s*['"]([^'"]+)['"]/);
                
                if (subjectMatch && messageMatch) {
                    document.getElementById('bulkEmailSubject').value = subjectMatch[1];
                    document.getElementById('bulkEmailMessage').value = messageMatch[1].trim();
                    
                    if (urlMatch) {
                        document.getElementById('appStoreUrl').value = urlMatch[1];
                    }
                    
                    // Ensure HTML template is checked
                    document.getElementById('bulkEmailUseHtml').checked = true;
                    
                    alert('App Store launch email template loaded! Don\'t forget to:\n\n1. Update the App Store URL with your actual App ID\n2. Review and customize the message\n3. Select your recipients');
                } else {
                    // Fallback to hardcoded template
                    loadAppStoreLaunchEmailFallback();
                }
            } catch (error) {
                console.error('Error loading template:', error);
                // Fallback to hardcoded template
                loadAppStoreLaunchEmailFallback();
            }
        }

        function loadAppStoreLaunchEmailFallback() {
            const template = {
                subject: " ORA is Now on the App Store!",
                message: `Hi {{displayName}},

We're thrilled to announce that ORA is now available on the App Store! 

ORA is the all-in-one platform designed specifically for content creators to manage their brand collaborations, track deals, and grow their business professionally.

**What Makes ORA Different:**

** See Real Reviews Before You Work With Brands & Agencies**
Never go into a collaboration blind. ORA's Brand Vault lets you see authentic reviews from other creators who've worked with brands and agencies. Know who pays on time, who's easy to work with, and who to avoid - all from real creator experiences. Make informed decisions and protect yourself from bad partnerships.

** Smart Rate Calculator - Know Your Worth**
Stop guessing what to charge. Our intelligent rate calculator analyzes your follower count, engagement rates, content type, and market data to suggest fair rates for your work. No more undercharging or awkward negotiations - get paid what you're actually worth based on real market data.

** AI Contract Analysis - Protect Your Rights**
Contracts can be confusing and full of hidden clauses. ORA's Contract Guard AI analyzes every contract before you sign, highlighting risky terms, unfair clauses, and potential red flags. Get instant insights on payment terms, usage rights, exclusivity clauses, and more. Sign with confidence knowing you're protected.

** Opportunity Pipeline - Never Miss a Deal**
Turn every inquiry into an opportunity. Track potential collaborations from first contact through to signed deals. See which brands are interested, follow up automatically, and never let a good opportunity slip through the cracks. Your entire sales pipeline, organized in one place.

** Revenue Tracking & Analytics**
See the full picture of your creator business. Track revenue across all platforms, collaborations, and brand deals in one place. Monitor your income trends, identify your most profitable partnerships, and get insights into your business growth. Know exactly how much you're earning and from where.

** Complete Business Management**
 Track all your brand deals, milestones, and deadlines in one organized dashboard
 Generate professional quotes and media kits that impress brands
 Build your brand partnerships library for easy reference
 Stay on top of payments, contracts, and deliverables
 Calendar integration to never miss a deadline
 And many more features to streamline your creator business

[App Store]

Download ORA today and take control of your creator business. The app is free to download with premium features available.

We built ORA because we know how challenging it can be to manage multiple brand deals, contracts, and payments while trying to create great content. ORA makes it all simple, organized, and professional - so you can focus on what you do best.

If you have any questions or feedback, just reply to this email - we'd love to hear from you!

Best regards,
The ORA Team

P.S. Share ORA with other creators who might find it helpful!`,
                appStoreUrl: 'https://apps.apple.com/us/app/my-ora/id6755090210'
            };
            
            document.getElementById('bulkEmailSubject').value = template.subject;
            document.getElementById('bulkEmailMessage').value = template.message;
            document.getElementById('appStoreUrl').value = template.appStoreUrl;
            document.getElementById('bulkEmailUseHtml').checked = true;
            
            alert('App Store launch email template loaded! Don\'t forget to:\n\n1. Update the App Store URL with your actual App ID\n2. Review and customize the message\n3. Select your recipients');
        }

        // Creator Pool Functions
        let creatorPoolData = [];
        let editingCreatorId = null;

        // Load creator pool from localStorage
        function loadCreatorPool() {
            try {
                const saved = localStorage.getItem('creatorPool');
                creatorPoolData = saved ? JSON.parse(saved) : [];
                renderCreatorPool();
            } catch (error) {
                console.error('Error loading creator pool:', error);
                creatorPoolData = [];
                renderCreatorPool();
            }
        }

        // Save creator pool to localStorage
        function saveCreatorPool() {
            try {
                localStorage.setItem('creatorPool', JSON.stringify(creatorPoolData));
            } catch (error) {
                console.error('Error saving creator pool:', error);
                alert('Error saving creator pool. Your browser may have storage limits.');
            }
        }

        // Render creator pool table
        function renderCreatorPool(filteredData = null) {
            const data = filteredData || creatorPoolData;
            const listEl = document.getElementById('creatorPoolList');
            const countEl = document.getElementById('creatorPoolCount');
            
            if (countEl) countEl.textContent = creatorPoolData.length;

            if (!data || data.length === 0) {
                listEl.innerHTML = '<div style="text-align: center; padding: 40px; color: #64748b;">No creators in pool yet. Add your first creator above!</div>';
                return;
            }

            listEl.innerHTML = `
                <div style="max-height: 500px; overflow-y: auto; border: 1px solid #e2e8f0; border-radius: 8px; padding: 12px; background: #ffffff;">
                    <div style="display: flex; align-items: center; gap: 12px; padding: 8px 12px; margin-bottom: 8px; background: rgba(249, 115, 22, 0.05); border: 1px solid rgba(249, 115, 22, 0.2); border-radius: 8px;">
                        <input type="checkbox" id="selectAllCreators" onchange="toggleAllCreatorsSelected()" style="width: 18px; height: 18px; cursor: pointer;">
                        <label for="selectAllCreators" style="color: #1e293b; font-size: 14px; font-weight: 600; cursor: pointer; flex: 1;">Select All Creators for Email</label>
                    </div>
                    <div style="display: flex; flex-direction: column; gap: 8px;">
                        ${data.map(creator => {
                            const socialMedia = [];
                            if (creator.instagram) socialMedia.push(` ${creator.instagram}`);
                            if (creator.tiktok) socialMedia.push(` ${creator.tiktok}`);
                            if (creator.youtube) socialMedia.push(` ${creator.youtube}`);
                            if (creator.twitter) socialMedia.push(` ${creator.twitter}`);
                            if (creator.other) socialMedia.push(` ${creator.other}`);
                            
                            // Default to selected if not set
                            const isSelected = creator.selectedForEmail !== false;
                            
                            return `
                                <label style="display: flex; align-items: start; gap: 12px; padding: 12px; background: rgba(255, 255, 255, 0.5); border: 1px solid #e2e8f0; border-radius: 8px; cursor: pointer; transition: background 0.2s;" 
                                       onmouseover="this.style.background='rgba(0,0,0,0.03)'" 
                                       onmouseout="this.style.background='rgba(255, 255, 255, 0.5)'">
                                    <input type="checkbox" class="creator-selected-checkbox" data-id="${creator.id}" id="creator-${creator.id}" ${isSelected ? 'checked' : ''} 
                                        onchange="toggleCreatorSelected('${creator.id}', this.checked)"
                                        style="width: 18px; height: 18px; cursor: pointer; margin-top: 2px; flex-shrink: 0;">
                                    <div style="flex: 1;">
                                        <div style="font-weight: 600; color: #1e293b; font-size: 14px; margin-bottom: 4px;">${escapeHtml(creator.name)}</div>
                                        <div style="color: #3b82f6; font-size: 13px; margin-bottom: 4px;">
                                            <a href="mailto:${escapeHtml(creator.email)}" style="color: #3b82f6; text-decoration: none;">${escapeHtml(creator.email)}</a>
                                        </div>
                                        ${socialMedia.length > 0 ? `<div style="color: #64748b; font-size: 12px; margin-top: 4px; margin-bottom: 4px;">${socialMedia.join('  ')}</div>` : ''}
                                        ${creator.notes ? `<div style="color: #64748b; font-size: 12px; margin-top: 4px; font-style: italic;">${escapeHtml(creator.notes)}</div>` : ''}
                                    </div>
                                    <div style="display: flex; gap: 8px; flex-shrink: 0;">
                                        <button onclick="event.stopPropagation(); editCreator('${creator.id}')" 
                                            style="padding: 6px 12px; background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.3); border-radius: 6px; color: #3b82f6; font-size: 12px; cursor: pointer; font-family: 'Inter', sans-serif;">
                                            Edit
                                        </button>
                                        <button onclick="event.stopPropagation(); deleteCreator('${creator.id}')" 
                                            style="padding: 6px 12px; background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 6px; color: #ef4444; font-size: 12px; cursor: pointer; font-family: 'Inter', sans-serif;">
                                            Delete
                                        </button>
                                    </div>
                                </label>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
            
            // Update select all checkbox state
            updateSelectAllCheckbox();
            updateSelectedCount();
        }

        // Escape HTML to prevent XSS
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Add or update creator
        function addCreator(event) {
            if (event) event.preventDefault();

            const name = document.getElementById('creatorName').value.trim();
            const email = document.getElementById('creatorEmail').value.trim();
            const instagram = document.getElementById('creatorInstagram').value.trim();
            const tiktok = document.getElementById('creatorTikTok').value.trim();
            const youtube = document.getElementById('creatorYouTube').value.trim();
            const twitter = document.getElementById('creatorTwitter').value.trim();
            const other = document.getElementById('creatorOther').value.trim();
            const notes = document.getElementById('creatorNotes').value.trim();

            if (!name || !email) {
                alert('Please fill in name and email');
                return;
            }

            // Validate email format
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                alert('Please enter a valid email address');
                return;
            }

            if (editingCreatorId) {
                // Update existing creator
                const index = creatorPoolData.findIndex(c => c.id === editingCreatorId);
                if (index !== -1) {
                    creatorPoolData[index] = {
                        ...creatorPoolData[index],
                        name,
                        email,
                        instagram,
                        tiktok,
                        youtube,
                        twitter,
                        other,
                        notes,
                        updatedAt: new Date().toISOString()
                    };
                }
                editingCreatorId = null;
            } else {
                // Add new creator
                const newCreator = {
                    id: Date.now().toString() + Math.random().toString(36).substr(2, 9),
                    name,
                    email,
                    instagram,
                    tiktok,
                    youtube,
                    twitter,
                    other,
                    notes,
                    selectedForEmail: true, // Default to selected
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                };
                creatorPoolData.push(newCreator);
            }

            saveCreatorPool();
            renderCreatorPool();
            
            // Reset form
            const wasEditing = editingCreatorId !== null;
            editingCreatorId = null;
            document.getElementById('creatorPoolForm').reset();
            document.querySelector('#creatorPoolForm button[type="submit"]').textContent = 'Add Creator';
            
            alert(wasEditing ? 'Creator updated!' : 'Creator added to pool!');
        }

        // Edit creator
        function editCreator(id) {
            const creator = creatorPoolData.find(c => c.id === id);
            if (!creator) return;

            document.getElementById('creatorName').value = creator.name || '';
            document.getElementById('creatorEmail').value = creator.email || '';
            document.getElementById('creatorInstagram').value = creator.instagram || '';
            document.getElementById('creatorTikTok').value = creator.tiktok || '';
            document.getElementById('creatorYouTube').value = creator.youtube || '';
            document.getElementById('creatorTwitter').value = creator.twitter || '';
            document.getElementById('creatorOther').value = creator.other || '';
            document.getElementById('creatorNotes').value = creator.notes || '';

            editingCreatorId = id;
            document.querySelector('#creatorPoolForm button[type="submit"]').textContent = 'Update Creator';
            
            // Scroll to form
            document.getElementById('creatorPoolForm').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        // Delete creator
        function deleteCreator(id) {
            if (!confirm('Are you sure you want to delete this creator from the pool?')) return;

            creatorPoolData = creatorPoolData.filter(c => c.id !== id);
            saveCreatorPool();
            renderCreatorPool();
        }

        // Filter creator pool
        function filterCreatorPool() {
            const searchTerm = document.getElementById('creatorPoolSearch').value.toLowerCase().trim();
            
            if (!searchTerm) {
                renderCreatorPool();
                return;
            }

            const filtered = creatorPoolData.filter(creator => {
                return (
                    creator.name.toLowerCase().includes(searchTerm) ||
                    creator.email.toLowerCase().includes(searchTerm) ||
                    (creator.instagram && creator.instagram.toLowerCase().includes(searchTerm)) ||
                    (creator.tiktok && creator.tiktok.toLowerCase().includes(searchTerm)) ||
                    (creator.youtube && creator.youtube.toLowerCase().includes(searchTerm)) ||
                    (creator.twitter && creator.twitter.toLowerCase().includes(searchTerm)) ||
                    (creator.other && creator.other.toLowerCase().includes(searchTerm)) ||
                    (creator.notes && creator.notes.toLowerCase().includes(searchTerm))
                );
            });

            renderCreatorPool(filtered);
        }

        // Clear all creators
        function clearCreatorPool() {
            if (!confirm('Are you sure you want to clear all creators from the pool? This cannot be undone.')) return;
            
            creatorPoolData = [];
            saveCreatorPool();
            renderCreatorPool();
            document.getElementById('creatorPoolSearch').value = '';
        }

        // Toggle creator selected state
        function toggleCreatorSelected(id, isSelected) {
            const creator = creatorPoolData.find(c => c.id === id);
            if (creator) {
                creator.selectedForEmail = isSelected;
                saveCreatorPool();
                updateSelectAllCheckbox();
                updateSelectedCount();
            }
        }

        // Toggle all creators selected
        function toggleAllCreatorsSelected() {
            const selectAllCheckbox = document.getElementById('selectAllCreators');
            const isChecked = selectAllCheckbox ? selectAllCheckbox.checked : false;
            
            creatorPoolData.forEach(creator => {
                creator.selectedForEmail = isChecked;
            });
            
            saveCreatorPool();
            renderCreatorPool();
            updateSelectedCount();
        }

        // Update select all checkbox state
        function updateSelectAllCheckbox() {
            const selectAllCheckbox = document.getElementById('selectAllCreators');
            if (!selectAllCheckbox) return;
            
            const allSelected = creatorPoolData.length > 0 && creatorPoolData.every(c => c.selectedForEmail !== false);
            const someSelected = creatorPoolData.some(c => c.selectedForEmail === true);
            
            selectAllCheckbox.checked = allSelected;
            selectAllCheckbox.indeterminate = someSelected && !allSelected;
        }

        // Update selected count
        function updateSelectedCount() {
            const selectedCount = creatorPoolData.filter(c => c.selectedForEmail !== false).length;
            const countEl = document.getElementById('selectedCreatorsCount');
            if (countEl) {
                countEl.textContent = selectedCount;
            }
        }

        // Export creator pool to CSV
        function exportCreatorPoolCSV() {
            if (creatorPoolData.length === 0) {
                alert('No creators to export');
                return;
            }

            const headers = ['Name', 'Email', 'Instagram', 'TikTok', 'YouTube', 'Twitter/X', 'Other', 'Notes', 'Added Date'];
            const rows = creatorPoolData.map(creator => [
                creator.name || '',
                creator.email || '',
                creator.instagram || '',
                creator.tiktok || '',
                creator.youtube || '',
                creator.twitter || '',
                creator.other || '',
                creator.notes || '',
                new Date(creator.createdAt).toLocaleDateString()
            ]);

            const csv = [
                headers.join(','),
                ...rows.map(row => row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(','))
            ].join('\n');

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `creator_pool_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Initialize creator pool form
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.getElementById('creatorPoolForm');
            if (form) {
                form.addEventListener('submit', addCreator);
            }
        });
    </script>

    <!-- Vercel Analytics -->
    <script src="https://va.vercel-scripts.com/v1/script.js" defer></script>

    <!-- Vercel Speed Insights -->
    <script src="https://va.vercel-scripts.com/v1/speed-insights/script.js" defer></script>
</body>
</html>
